<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Loan Archival System - Anvitha Finance</title>
  <!-- SheetJS Library for Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .header {
      padding: 30px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: #fff;
      text-align: center;
    }
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .content {
      padding: 30px;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
    }
    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
    }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-primary { background: #3498db; color: #fff; }
    .btn-success { background: #27ae60; color: #fff; }
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-warning { background: #f39c12; color: #fff; }
    .btn-info { background: #17a2b8; color: #fff; }
    .btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .results {
      margin-top: 20px;
    }
    .loan-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .loan-card.completed {
      border-left: 4px solid #27ae60;
      background: #d4edda;
    }
    .loan-card.selected {
      border: 3px solid #667eea;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }
    .loan-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
      margin-right: 10px;
    }
    .select-all-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .select-all-container label {
      font-weight: 600;
      color: #333;
      cursor: pointer;
    }
    .selection-count {
      margin-left: auto;
      padding: 6px 14px;
      background: #667eea;
      color: white;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }
    .loan-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .loan-header h3 {
      color: #2c3e50;
      font-size: 1.2em;
    }
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    .badge-success { background: #27ae60; color: #fff; }
    .badge-info { background: #3498db; color: #fff; }
    .loan-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .detail-item {
      font-size: 0.9em;
    }
    .detail-item strong {
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table th {
      background: #2c3e50;
      color: #fff;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }
    table tr:hover {
      background: #f8f9fa;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-card h3 {
      font-size: 2.5em;
      margin-bottom: 5px;
    }
    .stat-card p {
      font-size: 1em;
      opacity: 0.9;
    }
    .message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    
    /* ===== TOAST NOTIFICATION STYLES - CENTERED ===== */
    .toast-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        display: none;
        animation: fadeIn 0.3s ease-out;
    }
    
    .toast-backdrop.show {
        display: block;
    }
    
    .toast-container-center {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
        max-width: 500px;
        width: 90%;
    }
    
    .toast {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        margin-bottom: 10px;
        padding: 20px 24px;
        display: none;
        animation: slideInScale 0.3s ease-out;
        position: relative;
        border-left: 5px solid;
    }
    
    .toast.show {
        display: block;
    }
    
    .toast.success {
        border-left-color: #28a745;
        background: #d4edda;
    }
    
    .toast.error {
        border-left-color: #dc3545;
        background: #f8d7da;
    }
    
    .toast.warning {
        border-left-color: #ffc107;
        background: #fff3cd;
    }
    
    .toast.loading {
        border-left-color: #3498db;
        background: #e3f2fd;
    }
    
    .toast-content {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .toast-icon {
        font-size: 28px;
        line-height: 1;
        flex-shrink: 0;
    }
    
    .toast.success .toast-icon {
        color: #28a745;
    }
    
    .toast.error .toast-icon {
        color: #dc3545;
    }
    
    .toast.warning .toast-icon {
        color: #ffc107;
    }
    
    .toast.loading .toast-icon {
        color: #3498db;
    }
    
    .toast-message {
        flex: 1;
        font-size: 15px;
        line-height: 1.5;
        color: #2c3e50;
    }
    
    .toast-close {
        background: none;
        border: none;
        font-size: 24px;
        line-height: 1;
        color: #666;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
        transition: color 0.2s;
    }
    
    .toast-close:hover {
        color: #333;
    }
    
    .toast.hiding {
        animation: slideOutScale 0.3s ease-in forwards;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideInScale {
        from {
            transform: translateY(-20px) scale(0.9);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    
    @keyframes slideOutScale {
        from {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        to {
            transform: translateY(-20px) scale(0.9);
            opacity: 0;
        }
    }
    
    .toast-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(52, 152, 219, 0.2);
        border-top-color: #3498db;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    /* ===== EXCEL-LIKE TABLE STYLES FOR CLOSED LOANS ===== */
    .excel-wrapper {
      background: #f0f0f0;
      padding: 10px;
      overflow: auto;
      max-height: calc(100vh - 500px);
      margin-top: 20px;
    }

    .excel-container {
      display: inline-block;
      min-width: 100%;
      background: white;
      border: 1px solid #c0c0c0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .excel-table {
      border-collapse: collapse;
      font-family: 'Calibri', 'Arial', sans-serif;
      font-size: 11px;
      background: white;
      width: auto;
    }

    /* Checkbox column */
    .excel-table .checkbox-cell {
      background: #f0f0f0;
      border: 1px solid #c0c0c0;
      border-right: 2px solid #a0a0a0;
      text-align: center;
      padding: 4px;
      width: 30px;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .excel-table .checkbox-cell input[type="checkbox"] {
      cursor: pointer;
      width: 14px;
      height: 14px;
    }

    /* Row number column */
    .excel-table .row-number {
      background: #f0f0f0;
      border: 1px solid #c0c0c0;
      border-right: 2px solid #a0a0a0;
      text-align: center;
      font-weight: bold;
      color: #000;
      padding: 4px 8px;
      min-width: 40px;
      position: sticky;
      left: 30px;
      z-index: 5;
      user-select: none;
    }

    /* Column headers */
    .excel-table thead th {
      background: #f0f0f0;
      border: 1px solid #c0c0c0;
      border-bottom: 2px solid #a0a0a0;
      text-align: center;
      font-weight: bold;
      color: #000;
      padding: 6px 4px;
      min-width: 80px;
      position: sticky;
      top: 0;
      z-index: 10;
      user-select: none;
    }

    /* Column letter row */
    .excel-table .column-letter {
      background: #f0f0f0;
      border: 1px solid #c0c0c0;
      text-align: center;
      font-weight: bold;
      color: #000;
      padding: 4px;
      font-size: 10px;
    }

    /* Data cells */
    .excel-table td {
      border: 1px solid #e0e0e0;
      padding: 4px 6px;
      min-width: 80px;
      white-space: nowrap;
      color: #000;
      background: white;
    }

    .excel-table td.text-cell {
      text-align: left;
    }

    .excel-table td.number-cell {
      text-align: right;
      font-family: 'Courier New', monospace;
    }

    .excel-table td.date-cell {
      text-align: center;
    }

    .excel-table td.currency-cell {
      text-align: right;
      color: #008000;
      font-weight: 500;
    }

    .excel-table td.empty-cell {
      background: #fafafa;
      text-align: center;
      color: #999;
    }

    /* Row selection */
    .excel-table tbody tr.selected td {
      background: #cfe2ff !important;
    }

    .excel-table tbody tr:hover td {
      background: #f5f5f5;
    }

    .excel-table tbody tr.selected:hover td {
      background: #b6d4fe !important;
    }

    /* Controls for Excel table */
    .excel-controls {
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .excel-control-row {
      width: 100%;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    
    .excel-control-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .excel-search-box {
      flex: 1;
      min-width: 300px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .excel-search-box input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }
    
    .excel-search-box input:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .excel-stats-bar {
      padding: 15px 30px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      border-bottom: 2px solid #dee2e6;
    }
    
    .excel-stat-item {
      display: flex;
      flex-direction: column;
    }
    
    .excel-stat-label {
      font-size: 0.8rem;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .excel-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .excel-stat-item.total .excel-stat-value { color: #3498db; }
    .excel-stat-item.amount .excel-stat-value { color: #27ae60; }
    .excel-stat-item.filtered .excel-stat-value { color: #f39c12; }
    .excel-stat-item.selected .excel-stat-value { color: #e74c3c; }

    /* ===== ARCHIVE HEADER & TOOLS ===== */
    .archive-header {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 3px solid #e0e0e0;
    }

    .archive-title-section h2 {
      color: #2c3e50;
      font-size: 28px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .archive-tools-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .search-section {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .archive-search-input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #d0d0d0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .archive-search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .action-buttons-section {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .archive-btn {
      padding: 11px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .archive-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .search-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .clear-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .copy-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .clear-selection-btn {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }

    .export-btn {
      background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
      color: white;
    }

    .stats-bar {
      display: flex;
      gap: 15px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-item {
      flex: 1;
      text-align: center;
      color: white;
    }

    .stat-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      opacity: 0.85;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .stat-value {
      display: block;
      font-size: 26px;
      font-weight: 700;
    }

    /* ===== SIDEBAR STYLES ===== */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 70px;
      height: 100vh;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      gap: 15px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.2);
      z-index: 10000;
    }

    .sidebar-logo {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .sidebar-btn {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      text-decoration: none;
    }

    .sidebar-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .sidebar-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
    }

    body {
      margin-left: 70px;
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-logo">AF</div>
    <a href="home.html" class="sidebar-btn" title="Home">
      🏠
    </a>
    <a href="loan-archival-system-complete.html" class="sidebar-btn active" title="Loan Archive">
      📁
    </a>
  </div>

  <div class="toast-backdrop" id="toastBackdrop"></div>
  <div class="toast-container-center" id="toastContainer"></div>

  <div class="container">
    <div class="header">
      <h1>📁 Loan Archival System</h1>
      <p>Manage completed loans and archive them systematically</p>
    </div>

    <div class="content">
      <div class="info-box">
        <h3 style="margin-bottom:10px">How It Works</h3>
        <p><strong>Step 1:</strong> Click "Scan for Completed Loans" to analyze all active loans</p>
        <p><strong>Step 2:</strong> System checks BOTH emi_schedule AND emi_collection sheets for paid EMIs</p>
        <p><strong>Step 3:</strong> Compares paid count with Total Installments (Column K in Ledger)</p>
        <p><strong>Step 4:</strong> Completed loans are identified and displayed below</p>
        <p><strong>Step 5:</strong> Click "Archive Selected Loans" to move them to archive sheets</p>
        <p style="color:#e74c3c;margin-top:10px"><strong>Note:</strong> If emi_collection and emi_schedule show different counts, system uses the higher count and flags potential data sync issues</p>
      </div>

      <div class="warning-box">
        <strong>⚠ Important:</strong> This action will move completed loans to archive sheets and remove them from active sheets. Make sure you have a backup before proceeding.
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="scanCompletedLoans()">📊 Scan for Completed Loans</button>
        <button class="btn btn-success" id="archiveBtn" onclick="archiveSelectedLoans()" disabled>🗄️ Archive Selected Loans (<span id="selectedCount">0</span>)</button>
        <button class="btn btn-warning" onclick="showClosingLoans('thisMonth')">📅 Closing This Month</button>
        <button class="btn btn-warning" onclick="showClosingLoans('nextMonth')">📅 Closing Next Month</button>
        <button class="btn btn-info" onclick="viewClosedLoans()">👁️ View Closed Loans</button>
        <button class="btn btn-danger" onclick="location.href='home.html'">🏠 Back to Home</button>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Processing loans data...</p>
      </div>

      <div id="message" class="message"></div>

      <!-- Statistics -->
      <div id="statsContainer" style="display:none">
        <div class="stats">
          <div class="stat-card">
            <h3 id="completedCount">0</h3>
            <p>✅ Completed Loans Found</p>
          </div>
          <div class="stat-card">
            <h3 id="totalLoanCount">0</h3>
            <p>📋 Total Active Loans</p>
          </div>
        </div>
      </div>

      <!-- Completed Loans Results -->
      <div id="resultsContainer" style="display:none">
        <div class="select-all-container">
          <input type="checkbox" id="selectAllCheckbox" class="loan-checkbox" onchange="toggleSelectAll()">
          <label for="selectAllCheckbox">Select All Completed Loans</label>
          <span class="selection-count" id="selectionCount">0 selected</span>
        </div>
        <div id="completedLoans"></div>
      </div>



      <!-- Missing Loans -->
      <div id="missingLoansContainer" style="display:none;">
        <h2 style="margin-top:30px;margin-bottom:15px;color:#e74c3c">❌ Loans with Missing EMI Data</h2>
        <p style="margin-bottom:15px;color:#666" id="missingLoansSubtext"></p>
        <table id="missingLoansTable">
          <thead>
            <tr>
              <th>Loan No</th>
              <th>Customer Name</th>
              <th>Mobile</th>
              <th>Loan Amount</th>
              <th>Total Installments</th>
              <th>Loan Date</th>
            </tr>
          </thead>
          <tbody id="missingLoansBody"></tbody>
        </table>
      </div>
      <div id="closingLoansContainer" style="display:none;">
        <h2 style="margin-top:30px;margin-bottom:15px" id="closingLoansTitle">Loans Closing This Month</h2>
        <p style="margin-bottom:15px;color:#666" id="closingLoansSubtitle"></p>
        <table id="closingLoansTable">
          <thead>
            <tr>
              <th>Loan No</th>
              <th>Customer Name</th>
              <th>Mobile</th>
              <th>Total Installments</th>
              <th>Paid EMIs</th>
              <th>Remaining EMIs</th>
              <th>Last EMI Due Date</th>
              <th>Remaining Amount</th>
            </tr>
          </thead>
          <tbody id="closingLoansBody"></tbody>
        </table>
      </div>
      
      <!-- Results container for View Closed Loans with Excel-like table -->
      <div id="results"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPBMML2B8a6dMXMFL78dBIEeSRGG8yEhk2xn9BBEO_kx1kfan_Re73qOsIKAsjkQ8/exec';
    const SECRET = 'ANVITHA_SUPER_SECRET_2025';

    let completedLoansData = [];
    let activeLoansData = [];
    let selectedLoans = new Set();
    let totalLoansInLedger = 0;
    let allScheduleDataGlobal = [];
    let allLedgerDataGlobal = [];
    let closedLoansData = [];
    let filteredClosedLoans = [];
    let selectedClosedRows = new Set();

    // ===== TOAST NOTIFICATION SYSTEM =====
    let currentLoadingToast = null;

    function showToast(message, type = 'success', duration = 5000) {
        const container = document.getElementById('toastContainer');
        const backdrop = document.getElementById('toastBackdrop');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = '✓';
        if (type === 'error') icon = '✕';
        if (type === 'warning') icon = '⚠';
        if (type === 'loading') icon = '<div class="toast-spinner"></div>';
        
        toast.innerHTML = `
            <div class="toast-content">
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
                ${type !== 'loading' ? '<button class="toast-close" onclick="closeToast(this)">×</button>' : ''}
            </div>
        `;
        
        container.appendChild(toast);
        backdrop.classList.add('show');
        setTimeout(() => toast.classList.add('show'), 10);
        
        if (type !== 'loading' && duration > 0) {
            setTimeout(() => hideToast(toast), duration);
        }
        
        return toast;
    }

    function hideToast(toast) {
        const backdrop = document.getElementById('toastBackdrop');
        const container = document.getElementById('toastContainer');
        
        toast.classList.add('hiding');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
            if (container.children.length === 0) {
                backdrop.classList.remove('show');
            }
        }, 300);
    }

    function closeToast(button) {
        const toast = button.closest('.toast');
        hideToast(toast);
    }

    function hideLoadingToasts() {
        const loadingToasts = document.querySelectorAll('.toast.loading');
        loadingToasts.forEach(toast => hideToast(toast));
        if (currentLoadingToast) {
            hideToast(currentLoadingToast);
            currentLoadingToast = null;
        }
    }



    function showLoading(show) {
      // Hide old loading element
      document.getElementById('loading').style.display = 'none';
      
      if (show) {
        if (!currentLoadingToast) {
          currentLoadingToast = showToast('📊 Analyzing loans...', 'loading', 0);
        }
      } else {
        if (currentLoadingToast) {
          hideToast(currentLoadingToast);
          currentLoadingToast = null;
        }
        hideLoadingToasts();
      }
    }

    function showMessage(text, type = 'success') {
      // Updated to use toast notifications
      showToast(text, type, type === 'error' ? 7000 : 5000);
      
      // Keep old message element hidden for compatibility
      const msg = document.getElementById('message');
      msg.style.display = 'none';
    }

    async function scanCompletedLoans() {
      try {
        showLoading(true);
        
        // Hide stats and results initially
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('closingLoansContainer').style.display = 'none';

        // Fetch Ledger data
        const ledgerRes = await fetch(`${SCRIPT_URL}?action=searchCustomers&secret=${encodeURIComponent(SECRET)}`);
        const ledgerData = await ledgerRes.json();

        if (ledgerData.status !== 'success' || !ledgerData.data) {
          throw new Error('Failed to load ledger data');
        }
        
        console.log('Ledger data loaded successfully, count:', ledgerData.data.length);

        // Fetch all EMI collections
        const collectionRes = await fetch(`${SCRIPT_URL}?action=searchEMIRecords&secret=${encodeURIComponent(SECRET)}`);
        const collectionData = await collectionRes.json();

        if (collectionData.status !== 'success' || !collectionData.records) {
          throw new Error('Failed to load collection data');
        }

        // Fetch all EMI schedules
        const scheduleRes = await fetch(`${SCRIPT_URL}?action=getAllEMISchedule&secret=${encodeURIComponent(SECRET)}`);
        const scheduleData = await scheduleRes.json();

        if (scheduleData.status !== 'success' || !scheduleData.schedule) {
          throw new Error('Failed to load schedule data');
        }

        // Analyze loans
        completedLoansData = [];
        activeLoansData = [];
        selectedLoans.clear();

        // Count total loans properly - only count rows with loan numbers
        totalLoansInLedger = ledgerData.data.filter(loan => {
          const loanNo = String(loan['Loan No'] || loan['Loan Number'] || '').trim();
          return loanNo !== '';
        }).length;

        console.log('Total loans with loan numbers in Ledger:', totalLoansInLedger);
        
        let skippedCount = 0;
        const skippedReasons = [];

        ledgerData.data.forEach((loan, index) => {
          const loanNo = String(loan['Loan No'] || loan['Loan Number'] || '').trim();
          
          if (!loanNo) {
            skippedCount++;
            skippedReasons.push(`Row ${index + 1}: No loan number`);
            return;
          }

          const totalInstallments = parseInt(loan['No of monthly instalments'] || 
                                            loan['No of Installments'] || 
                                            loan['Installments'] || 0);

          if (!totalInstallments || totalInstallments === 0) {
            skippedCount++;
            skippedReasons.push(`Loan ${loanNo}: No installments specified`);
            return;
          }

          // Count paid EMIs from both sheets
          const collectionCount = collectionData.records.filter(r => 
            String(r['Loan No'] || r['Loan Number'] || '').trim() === loanNo
          ).length;

          const scheduleCount = scheduleData.schedule.filter(s => 
            String(s['Loan No'] || s['Loan Number'] || '').trim() === loanNo && 
            String(s['Paid'] || '').toLowerCase() === 'yes'
          ).length;

          // Use the higher count
          const paidEMIs = Math.max(collectionCount, scheduleCount);
          const hasDataSyncIssue = collectionCount !== scheduleCount && collectionCount > 0 && scheduleCount > 0;

          const loanInfo = {
            loanNo,
            customerName: loan['Name of the customer'] || loan['Name of the Borrower'] || 'Unknown',
            mobile: loan['Mobile No'] || loan['Mobile'] || 'N/A',
            vehicleReg: loan['Reg No'] || loan['Registration Number of the Vehicle'] || 'N/A',
            loanAmount: parseFloat(loan['Loan Amount'] || 0),
            totalInstallments,
            paidEMIs,
            collectionCount,
            scheduleCount,
            hasDataSyncIssue,
            dateOfLoan: loan['Date of loan'] || loan['Loan Date'] || 'N/A'
          };

          if (paidEMIs >= totalInstallments) {
            completedLoansData.push(loanInfo);
          } else {
            activeLoansData.push(loanInfo);
          }
        });

        console.log('Completed loans:', completedLoansData.length);
        console.log('Active loans:', activeLoansData.length);
        console.log('Skipped entries:', skippedCount);
        if (skippedCount > 0) {
          console.log('Skip reasons:', skippedReasons);
        }

        showLoading(false);

        // Update UI
        document.getElementById('completedCount').textContent = completedLoansData.length;
        document.getElementById('totalLoanCount').textContent = totalLoansInLedger;
        document.getElementById('statsContainer').style.display = 'block';

        if (completedLoansData.length > 0) {
          displayCompletedLoans();
          document.getElementById('resultsContainer').style.display = 'block';
        } else {
          showMessage('No completed loans found!', 'warning');
        }

        // Display active loans - REMOVED
        // if (activeLoansData.length > 0) {
        //   displayActiveLoans();
        // }

      } catch (err) {
        showLoading(false);
        showMessage('Error: ' + err.message, 'error');
        console.error('Scan error:', err);
      }
    }

    function displayCompletedLoans() {
      const container = document.getElementById('completedLoans');
      let html = '';

      completedLoansData.forEach((loan) => {
        const syncWarning = loan.hasDataSyncIssue ? 
          `<span style="color:#e74c3c;font-size:0.85em">⚠ Data sync issue (Collection: ${loan.collectionCount}, Schedule: ${loan.scheduleCount})</span>` : '';
        
        html += `
          <div class="loan-card completed">
            <div class="loan-header">
              <div style="display:flex;align-items:center;gap:10px">
                <input type="checkbox" class="loan-checkbox" data-loan-no="${loan.loanNo}" onchange="toggleLoanSelection(this)">
                <h3>Loan #${loan.loanNo}</h3>
              </div>
              <span class="badge badge-success">✅ Completed</span>
            </div>
            <div class="loan-details">
              <div class="detail-item"><strong>Customer:</strong> ${loan.customerName}</div>
              <div class="detail-item"><strong>Mobile:</strong> ${loan.mobile}</div>
              <div class="detail-item"><strong>Vehicle:</strong> ${loan.vehicleReg}</div>
              <div class="detail-item"><strong>Loan Amount:</strong> ₹${loan.loanAmount.toLocaleString('en-IN')}</div>
              <div class="detail-item"><strong>EMIs Paid:</strong> ${loan.paidEMIs} / ${loan.totalInstallments}</div>
              <div class="detail-item"><strong>Loan Date:</strong> ${loan.dateOfLoan}</div>
            </div>
            ${syncWarning ? `<div style="margin-top:10px">${syncWarning}</div>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;
      updateSelectionCount();
      updateArchiveButton();
    }

    /* REMOVED - displayActiveLoans function
    function displayActiveLoans() {
      const container = document.getElementById('activeLoans');
      const countElement = document.getElementById('activeLoansCount');
      
      countElement.textContent = `${activeLoansData.length} active loans (not yet completed)`;
      
      let html = '';
      activeLoansData.forEach((loan) => {
        const remaining = loan.totalInstallments - loan.paidEMIs;
        const progress = (loan.paidEMIs / loan.totalInstallments * 100).toFixed(1);
        
        html += `
          <div class="loan-card">
            <div class="loan-header">
              <h3>Loan #${loan.loanNo}</h3>
              <span class="badge badge-info">🔄 Active</span>
            </div>
            <div class="loan-details">
              <div class="detail-item"><strong>Customer:</strong> ${loan.customerName}</div>
              <div class="detail-item"><strong>Mobile:</strong> ${loan.mobile}</div>
              <div class="detail-item"><strong>Vehicle:</strong> ${loan.vehicleReg}</div>
              <div class="detail-item"><strong>Loan Amount:</strong> ₹${loan.loanAmount.toLocaleString('en-IN')}</div>
              <div class="detail-item"><strong>Progress:</strong> ${loan.paidEMIs} / ${loan.totalInstallments} (${progress}%)</div>
              <div class="detail-item"><strong>Remaining:</strong> ${remaining} EMIs</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      document.getElementById('activeLoansContainer').style.display = 'block';
    }
    */

    function toggleLoanSelection(checkbox) {
      const loanNo = checkbox.dataset.loanNo;
      
      if (checkbox.checked) {
        selectedLoans.add(loanNo);
      } else {
        selectedLoans.delete(loanNo);
      }
      
      const card = checkbox.closest('.loan-card');
      if (checkbox.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
      
      updateSelectionCount();
      updateArchiveButton();
    }

    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const allCheckboxes = document.querySelectorAll('.loan-card input[type="checkbox"]');
      
      selectedLoans.clear();
      
      allCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        const card = checkbox.closest('.loan-card');
        
        if (selectAllCheckbox.checked) {
          selectedLoans.add(checkbox.dataset.loanNo);
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
      
      updateSelectionCount();
      updateArchiveButton();
    }

    function updateSelectionCount() {
      const count = selectedLoans.size;
      document.getElementById('selectionCount').textContent = `${count} selected`;
      document.getElementById('selectedCount').textContent = count;
      
      const totalCheckboxes = document.querySelectorAll('.loan-card input[type="checkbox"]').length;
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      
      if (count === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (count === totalCheckboxes) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }

    function updateArchiveButton() {
      const archiveBtn = document.getElementById('archiveBtn');
      archiveBtn.disabled = selectedLoans.size === 0;
    }

    async function archiveSelectedLoans() {
      if (selectedLoans.size === 0) {
        showMessage('Please select at least one loan to archive', 'warning');
        return;
      }

      const confirmMsg = `Are you sure you want to archive ${selectedLoans.size} selected loan(s)?\n\nThis will:\n- Move loan records to Closed_Loans sheet\n- Move collection records to Closed_emi_collection sheet\n- Move schedule records to Closed_emi_schedule sheet\n- Remove them from active sheets\n\nThis action cannot be undone!`;

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        showLoading(true);
        let successCount = 0;
        let failCount = 0;
        const failedLoans = [];

        for (const loanNo of Array.from(selectedLoans)) {
          const payload = {
            action: 'archiveLoan',
            secret: SECRET,
            loanNumber: loanNo
          };

          try {
            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' },
              body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (data.status === 'success') {
              successCount++;
            } else {
              failCount++;
              failedLoans.push(loanNo);
            }
          } catch (err) {
            failCount++;
            failedLoans.push(loanNo);
          }
        }

        showLoading(false);

        if (successCount > 0) {
          showMessage(
            `Successfully archived ${successCount} loan(s)${failCount > 0 ? `, ${failCount} failed` : ''}`,
            failCount > 0 ? 'warning' : 'success'
          );
          
          if (failCount > 0) {
            console.error('Failed to archive loans:', failedLoans);
          }
          
          // Refresh the scan after archival
          selectedLoans.clear();
          setTimeout(() => scanCompletedLoans(), 2000);
        } else {
          showMessage('Failed to archive selected loans', 'error');
        }

      } catch (err) {
        showLoading(false);
        showMessage('Error: ' + err.message, 'error');
      }
    }

    // View all closed loans from Closed_Ledger sheet with Excel-like table
    async function viewClosedLoans() {
      try {
        showLoading(true);
        document.getElementById('results').innerHTML = '';
        
        // Hide other containers
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('closingLoansContainer').style.display = 'none';
        
        const url = `${SCRIPT_URL}?action=getAllClosedLoans&secret=${SECRET}`;
        const response = await fetch(url);
        const data = await response.json();
        
        showLoading(false);
        
        if (data.status === 'success' && Array.isArray(data.loans)) {
          const loans = data.loans;
          
          if (loans.length === 0) {
            showMessage('No closed loans found in the archive', 'warning');
            return;
          }
          
          // Debug: Log the first loan's keys to see column names
          if (loans.length > 0) {
            console.log('Column names in Closed_Loans sheet:', Object.keys(loans[0]));
            console.log('First loan data:', loans[0]);
          }
          
          closedLoansData = loans;
          filteredClosedLoans = [...loans];
          selectedClosedRows.clear();
          displayClosedLoansExcelTable();
          
        } else {
          showMessage(data.message || 'Failed to load closed loans', 'error');
        }
      } catch (err) {
        showLoading(false);
        showMessage('Error loading closed loans: ' + err.message, 'error');
        console.error(err);
      }
    }

    function displayClosedLoansExcelTable() {
      const container = document.getElementById('results');
      
      // Complete column definitions matching the Google Sheets Closed_Loans sheet exactly
      const columns = [
        { key: 'sno', label: 'S No', class: 'number-cell' },
        { key: 'customerName', label: 'Name of the customer', class: 'text-cell' },
        { key: 'mobile', label: 'Mobile No', class: 'text-cell' },
        { key: 'fatherName', label: 'S/o W/o', class: 'text-cell' },
        { key: 'village', label: 'Name of the village', class: 'text-cell' },
        { key: 'address', label: 'Address', class: 'text-cell' },
        { key: 'loanNo', label: 'Loan No', class: 'number-cell' },
        { key: 'dateOfLoan', label: 'Date of loan', class: 'date-cell' },
        { key: 'loanAmount', label: 'Loan Amount', class: 'currency-cell', format: 'currency' },
        { key: 'rateOfInterest', label: 'Rate of Intt', class: 'number-cell' },
        { key: 'noOfInstallments', label: 'No of monthly instalments', class: 'number-cell' },
        { key: 'interestPerMonth', label: 'Intt per one month', class: 'currency-cell', format: 'currency' },
        { key: 'interest', label: 'Interest', class: 'currency-cell', format: 'currency' },
        { key: 'principalAmt', label: 'Principal amt', class: 'currency-cell', format: 'currency' },
        { key: 'totalEMI', label: 'Total EMI', class: 'currency-cell', format: 'currency' },
        { key: 'totalInterest', label: 'Total Intt', class: 'currency-cell', format: 'currency' },
        { key: 'principal', label: 'Principal', class: 'currency-cell', format: 'currency' },
        { key: 'totalAmountLoanPlusInt', label: 'Amt (Loan Amt + Intt)', class: 'currency-cell', format: 'currency' },
        { key: 'dateOfInstallmentStart', label: 'Date of instalment starting', class: 'date-cell' },
        { key: 'totalAmountToBePaid', label: 'Total amt to be paid', class: 'currency-cell', format: 'currency' },
        { key: 'difference', label: 'Difference between principal & total amt to be paid', class: 'currency-cell', format: 'currency' },
        { key: 'makeOfVehicle', label: 'Make of vehicle', class: 'text-cell' },
        { key: 'yearOfManufacturing', label: 'Year of manufacturing', class: 'number-cell' },
        { key: 'regNo', label: 'Reg No', class: 'text-cell' },
        { key: 'insuranceName', label: 'Name of Ins Co', class: 'text-cell' },
        { key: 'insuranceValidity', label: 'Ins valid upto', class: 'date-cell' },
        { key: 'chassisNo', label: 'Chassis No', class: 'text-cell' },
        { key: 'engineNo', label: 'Engine No', class: 'text-cell' },
        { key: 'suretyName', label: 'Name of the surety holder', class: 'text-cell' },
        { key: 'suretyFatherName', label: 'Surety S/O W/O', class: 'text-cell' },
        { key: 'suretyMobile', label: 'Surety Mobile', class: 'text-cell' },
        { key: 'suretyAddress', label: 'Surety Address', class: 'text-cell' },
        { key: 'thumb', label: 'Thumb Yes/No', class: 'text-cell' }
      ];

      // Generate column letters (A, B, C, ...)
      const getColumnLetter = (index) => {
        let letter = '';
        while (index >= 0) {
          letter = String.fromCharCode((index % 26) + 65) + letter;
          index = Math.floor(index / 26) - 1;
        }
        return letter;
      };

      let html = `
        <div style="margin-top: 20px;">
          <!-- Header -->
          <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">📁</span>
            Closed Loans Archive (${closedLoansData.length} loans)
          </h3>

          <!-- Tools Card Section -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
            
            <!-- Actions Section -->
            <div style="background: white; padding: 20px; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">⚡ Quick Actions</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="copyClosedBtn" onclick="copySelectedClosedRows()" style="padding: 12px 24px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(79,172,254,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  📋 Copy Selected
                </button>
                <button onclick="clearClosedSelection()" style="padding: 12px 24px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(250,112,154,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  ✕ Clear Selection
                </button>
                <button onclick="exportClosedToExcel()" style="padding: 12px 24px; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(48,207,208,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  📥 Export to Excel
                </button>
              </div>
            </div>

          </div>

          <!-- Excel Stats Bar -->
          <div class="excel-stats-bar">
            <div class="excel-stat-item total">
              <div class="excel-stat-label">Total Records</div>
              <div class="excel-stat-value" id="totalClosedRecords">${closedLoansData.length}</div>
            </div>
            <div class="excel-stat-item filtered">
              <div class="excel-stat-label">Displayed Records</div>
              <div class="excel-stat-value" id="displayedClosedRecords">${filteredClosedLoans.length}</div>
            </div>
            <div class="excel-stat-item selected">
              <div class="excel-stat-label">Selected Rows</div>
              <div class="excel-stat-value" id="selectedClosedRecords">0</div>
            </div>
            <div class="excel-stat-item amount">
              <div class="excel-stat-label">Total Loan Amount</div>
              <div class="excel-stat-value" id="totalClosedLoanAmount">₹0</div>
            </div>
          </div>

          <!-- Excel Table -->
          <div class="excel-wrapper">
            <div class="excel-container">
              <table class="excel-table">
                <thead>
                  <tr>
                    <th class="checkbox-cell"><input type="checkbox" id="selectAllClosed" onchange="toggleSelectAllClosed()"></th>
                    <th class="row-number">#</th>
      `;

      // Column letters
      columns.forEach((col, idx) => {
        html += `<th class="column-letter">${getColumnLetter(idx)}</th>`;
      });
      html += `</tr><tr><th class="checkbox-cell"></th><th class="row-number"></th>`;
      
      // Column headers
      columns.forEach(col => {
        html += `<th>${col.label}</th>`;
      });
      
      html += `</tr></thead><tbody id="closedLoansTableBody">`;
      
      // Data rows
      filteredClosedLoans.forEach((loan, index) => {
        // Helper function to get column value - case insensitive and flexible
        const getColumnValue = (loan, ...possibleNames) => {
          // First try exact match
          for (let name of possibleNames) {
            if (loan[name] !== undefined && loan[name] !== null && loan[name] !== '') {
              return loan[name];
            }
          }
          
          // Then try case-insensitive match
          const loanKeys = Object.keys(loan);
          for (let name of possibleNames) {
            const normalizedName = name.toLowerCase().trim();
            for (let key of loanKeys) {
              const normalizedKey = key.toLowerCase().trim();
              if (normalizedKey === normalizedName) {
                if (loan[key] !== undefined && loan[key] !== null && loan[key] !== '') {
                  return loan[key];
                }
              }
            }
          }
          
          // Finally try partial match for rate of interest specifically
          if (possibleNames.some(n => n.toLowerCase().includes('rate'))) {
            for (let key of loanKeys) {
              const lowerKey = key.toLowerCase();
              if (lowerKey.includes('rate') && (lowerKey.includes('int') || lowerKey.includes('intt'))) {
                if (loan[key] !== undefined && loan[key] !== null && loan[key] !== '') {
                  return loan[key];
                }
              }
            }
          }
          
          return '';
        };

        // Debug: Log rate of interest for first loan
        if (index === 0) {
          console.log('=== DEBUGGING RATE OF INTEREST ===');
          console.log('All keys in first loan:', Object.keys(loan));
          console.log('First 5 loan entries:', Object.entries(loan).slice(0, 15));
          
          // Try all possible rate variations
          const rateVariations = [
            'Rate of Intt',
            'Rate of Interest', 
            'Rate of interest',
            'Rate of Intt.',
            'Rate',
            'rate of intt',
            'rate of interest',
            'RATE OF INTT',
            'RATE OF INTEREST'
          ];
          
          console.log('Trying rate variations:');
          rateVariations.forEach(key => {
            if (loan[key] !== undefined) {
              console.log(`  ✓ Found: "${key}" = ${loan[key]}`);
            }
          });
          
          // Find any key containing "rate" or "intt"
          console.log('Keys containing "rate" or "intt":');
          Object.keys(loan).forEach(key => {
            const lowerKey = key.toLowerCase();
            if (lowerKey.includes('rate') || lowerKey.includes('intt')) {
              console.log(`  → "${key}" = ${loan[key]}`);
            }
          });
          
          // Show what we're actually using
          const extractedRate = getColumnValue(loan, 'Rate of Intt', 'Rate of Interest', 'Rate of interest', 'Rate of Intt.', 'Rate');
          console.log('Final extracted rate:', extractedRate);
          console.log('=== END DEBUG ===');
        }

        // Extract all fields matching Google Sheets columns
        const rowData = {
          sno: getColumnValue(loan, 'S No', 'S.No', 'SNo') || (index + 1),
          customerName: getColumnValue(loan, 'Name of the customer', 'Customer Name', 'Name of the Borrower') || '-',
          mobile: formatMobile(getColumnValue(loan, 'Mobile No', 'Mobile')) || '-',
          fatherName: getColumnValue(loan, 'S/o W/o', 'S/O W/O', 'Father Name') || '-',
          village: getColumnValue(loan, 'Name of the village', 'Village') || '-',
          address: getColumnValue(loan, 'Address') || '-',
          loanNo: getColumnValue(loan, 'Loan No', 'LoanNo', 'Loan Number') || '-',
          dateOfLoan: formatDateValue(getColumnValue(loan, 'Date of loan', 'Date of Loan')),
          loanAmount: parseFloat(getColumnValue(loan, 'Loan Amount')) || 0,
          rateOfInterest: getColumnValue(loan, 'Rate of Intt', 'Rate of Interest', 'Rate of interest', 'Rate of Intt.', 'Rate', 'rate of intt', 'rate of interest') || '-',
          noOfInstallments: getColumnValue(loan, 'No of monthly instalments', 'No of monthly Ins', 'No of Installments', 'K') || '-',
          interestPerMonth: parseFloat(getColumnValue(loan, 'Intt per one month', 'Interest per month')) || 0,
          interest: parseFloat(getColumnValue(loan, 'Interest')) || 0,
          principalAmt: parseFloat(getColumnValue(loan, 'Principal amt', 'Principal Amt')) || 0,
          totalEMI: parseFloat(getColumnValue(loan, 'Total EMI', 'Total Emi')) || 0,
          totalInterest: parseFloat(getColumnValue(loan, 'Total Intt', 'Total Interest')) || 0,
          principal: parseFloat(getColumnValue(loan, 'Principal', 'Total Principal')) || 0,
          totalAmountLoanPlusInt: parseFloat(getColumnValue(loan, 'Amt (Loan Amt + Intt)', 'Total Amt (Loan Amt + Intt)', 'Total Amount')) || 0,
          dateOfInstallmentStart: formatDateValue(getColumnValue(loan, 'Date of instalment starting', 'Date of Instalment Starting')),
          totalAmountToBePaid: parseFloat(getColumnValue(loan, 'Total amt to be paid', 'Total Amount to be Paid')) || 0,
          difference: parseFloat(getColumnValue(loan, 'Difference between principal & total amt to be paid', 'Difference')) || 0,
          makeOfVehicle: getColumnValue(loan, 'Make of vehicle', 'Make of Vehicle') || '-',
          yearOfManufacturing: getColumnValue(loan, 'Year of manufacturing', 'Year of Manufacturing') || '-',
          regNo: getColumnValue(loan, 'Reg No', 'Registration Number', 'Registration Number of the Vehicle') || '-',
          insuranceName: getColumnValue(loan, 'Name of Ins Co', 'Insurance Name') || '-',
          insuranceValidity: formatDateValue(getColumnValue(loan, 'Ins valid upto', 'Insurance Validity')),
          chassisNo: getColumnValue(loan, 'Chassis No', 'Chasis Number') || '-',
          engineNo: getColumnValue(loan, 'Engine No', 'Engine Number') || '-',
          suretyName: getColumnValue(loan, 'Name of the surety holder', 'Surety Name') || '-',
          suretyFatherName: getColumnValue(loan, 'Surety S/O W/O', 'Surety Father Name') || '-',
          suretyMobile: formatMobile(getColumnValue(loan, 'Surety Mobile')) || '-',
          suretyAddress: getColumnValue(loan, 'Surety Address') || '-',
          thumb: getColumnValue(loan, 'Thumb Yes/No', 'Thumb (Yes/No)', 'Thumb') || '-'
        };

        html += `
          <tr data-index="${index}">
            <td class="checkbox-cell">
              <input type="checkbox" onchange="toggleClosedRowSelection(${index})">
            </td>
            <td class="row-number">${index + 1}</td>
            <td class="number-cell">${rowData.sno}</td>
            <td class="text-cell">${rowData.customerName}</td>
            <td class="text-cell">${rowData.mobile}</td>
            <td class="text-cell">${rowData.fatherName}</td>
            <td class="text-cell">${rowData.village}</td>
            <td class="text-cell">${rowData.address}</td>
            <td class="number-cell">${rowData.loanNo}</td>
            <td class="date-cell">${rowData.dateOfLoan}</td>
            <td class="currency-cell">${formatCurrency(rowData.loanAmount)}</td>
            <td class="number-cell">${rowData.rateOfInterest}</td>
            <td class="number-cell">${rowData.noOfInstallments}</td>
            <td class="currency-cell">${formatCurrency(rowData.interestPerMonth)}</td>
            <td class="currency-cell">${formatCurrency(rowData.interest)}</td>
            <td class="currency-cell">${formatCurrency(rowData.principalAmt)}</td>
            <td class="currency-cell">${formatCurrency(rowData.totalEMI)}</td>
            <td class="currency-cell">${formatCurrency(rowData.totalInterest)}</td>
            <td class="currency-cell">${formatCurrency(rowData.principal)}</td>
            <td class="currency-cell">${formatCurrency(rowData.totalAmountLoanPlusInt)}</td>
            <td class="date-cell">${rowData.dateOfInstallmentStart}</td>
            <td class="currency-cell">${formatCurrency(rowData.totalAmountToBePaid)}</td>
            <td class="currency-cell">${formatCurrency(rowData.difference)}</td>
            <td class="text-cell">${rowData.makeOfVehicle}</td>
            <td class="number-cell">${rowData.yearOfManufacturing}</td>
            <td class="text-cell">${rowData.regNo}</td>
            <td class="text-cell">${rowData.insuranceName}</td>
            <td class="date-cell">${rowData.insuranceValidity}</td>
            <td class="text-cell">${rowData.chassisNo}</td>
            <td class="text-cell">${rowData.engineNo}</td>
            <td class="text-cell">${rowData.suretyName}</td>
            <td class="text-cell">${rowData.suretyFatherName}</td>
            <td class="text-cell">${rowData.suretyMobile}</td>
            <td class="text-cell">${rowData.suretyAddress}</td>
            <td class="text-cell">${rowData.thumb}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table></div></div></div>`;
      
      container.innerHTML = html;
      updateClosedLoansStats();
    }

    function formatCurrency(amount) {
      if (!amount || isNaN(amount)) return '₹0';
      return '₹' + parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatMobile(mobile) {
      const num = mobile ? mobile.toString().split('.')[0] : '';
      return num;
    }

    function parseDate(dateStr) {
      if (!dateStr) return { day: '', month: '', year: '' };
      
      // Handle ISO format dates (with T and Z)
      if (typeof dateStr === 'string' && (dateStr.includes('T') || dateStr.includes('Z'))) {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return {
            day: String(date.getDate()).padStart(2, '0'),
            month: String(date.getMonth() + 1).padStart(2, '0'),
            year: String(date.getFullYear())
          };
        }
      }
      
      // Try to parse as regular date
      const date = new Date(dateStr);
      if (!isNaN(date.getTime())) {
        return {
          day: String(date.getDate()).padStart(2, '0'),
          month: String(date.getMonth() + 1).padStart(2, '0'),
          year: String(date.getFullYear())
        };
      }
      
      // Try to parse dd-mm-yyyy or dd/mm/yyyy format
      const parts = dateStr.toString().split(/[\/\-]/);
      if (parts.length === 3) {
        return {
          day: parts[0].padStart(2, '0'),
          month: parts[1].padStart(2, '0'),
          year: parts[2]
        };
      }
      
      return { day: '', month: '', year: '' };
    }

    function formatDateValue(value) {
      if (!value) return '-';
      
      // Handle ISO format timestamps
      if (typeof value === 'string' && (value.includes('T') || value.includes('Z'))) {
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = String(date.getFullYear());
          return `${day}-${month}-${year}`;
        }
      }
      
      // Try parsing as date
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear());
        return `${day}-${month}-${year}`;
      }
      
      // If already in dd-mm-yyyy format, return as is
      if (typeof value === 'string' && /^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/.test(value)) {
        return value;
      }
      
      return value || '-';
    }

    function toggleClosedRowSelection(index) {
      if (selectedClosedRows.has(index)) {
        selectedClosedRows.delete(index);
        document.querySelector(`#closedLoansTableBody tr[data-index="${index}"]`).classList.remove('selected');
      } else {
        selectedClosedRows.add(index);
        document.querySelector(`#closedLoansTableBody tr[data-index="${index}"]`).classList.add('selected');
      }
      updateClosedSelectionUI();
    }

    function toggleSelectAllClosed() {
      const selectAll = document.getElementById('selectAllClosed');
      const checkboxes = document.querySelectorAll('#closedLoansTableBody input[type="checkbox"]');
      
      selectedClosedRows.clear();
      checkboxes.forEach((cb, idx) => {
        cb.checked = selectAll.checked;
        if (selectAll.checked) {
          selectedClosedRows.add(idx);
          document.querySelector(`#closedLoansTableBody tr[data-index="${idx}"]`).classList.add('selected');
        } else {
          document.querySelector(`#closedLoansTableBody tr[data-index="${idx}"]`).classList.remove('selected');
        }
      });
      
      updateClosedSelectionUI();
    }

    function clearClosedSelection() {
      selectedClosedRows.clear();
      document.getElementById('selectAllClosed').checked = false;
      document.querySelectorAll('#closedLoansTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#closedLoansTableBody tr.selected').forEach(tr => tr.classList.remove('selected'));
      updateClosedSelectionUI();
      showToast('Selection cleared');
    }

    function updateClosedSelectionUI() {
      document.getElementById('selectedClosedRecords').textContent = selectedClosedRows.size;
      document.getElementById('copyClosedBtn').disabled = selectedClosedRows.size === 0;
    }

    function copySelectedClosedRows() {
      if (selectedClosedRows.size === 0) {
        showToast('No rows selected', 'error');
        return;
      }

      const selectedData = Array.from(selectedClosedRows).sort((a, b) => a - b).map(idx => filteredClosedLoans[idx]);
      
      let copyText = '';
      
      selectedData.forEach(loan => {
        // Helper function to get column value
        const getColumnValue = (loan, ...possibleNames) => {
          for (let name of possibleNames) {
            if (loan[name] !== undefined && loan[name] !== null && loan[name] !== '') {
              return loan[name];
            }
          }
          return '';
        };

        const rowData = [
          getColumnValue(loan, 'S No', 'S.No', 'SNo') || '',
          getColumnValue(loan, 'Name of the customer', 'Customer Name') || '',
          formatMobile(getColumnValue(loan, 'Mobile No', 'Mobile')) || '',
          getColumnValue(loan, 'S/o W/o', 'S/O W/O', 'Father Name') || '',
          getColumnValue(loan, 'Name of the village', 'Village') || '',
          getColumnValue(loan, 'Address') || '',
          getColumnValue(loan, 'Loan No', 'LoanNo') || '',
          formatDateValue(getColumnValue(loan, 'Date of loan', 'Date of Loan')),
          getColumnValue(loan, 'Loan Amount') || '',
          getColumnValue(loan, 'Rate of Intt', 'Rate of Interest') || '',
          getColumnValue(loan, 'No of monthly instalments', 'No of monthly Ins') || '',
          getColumnValue(loan, 'Intt per one month', 'Interest per month') || '',
          getColumnValue(loan, 'Interest') || '',
          getColumnValue(loan, 'Principal amt', 'Principal Amt') || '',
          getColumnValue(loan, 'Total EMI', 'Total Emi') || '',
          getColumnValue(loan, 'Total Intt', 'Total Interest') || '',
          getColumnValue(loan, 'Principal', 'Total Principal') || '',
          getColumnValue(loan, 'Amt (Loan Amt + Intt)', 'Total Amt (Loan Amt + Intt)') || '',
          formatDateValue(getColumnValue(loan, 'Date of instalment starting', 'Date of Instalment Starting')),
          getColumnValue(loan, 'Total amt to be paid', 'Total Amount to be Paid') || '',
          getColumnValue(loan, 'Difference between principal & total amt to be paid', 'Difference') || '',
          getColumnValue(loan, 'Make of vehicle', 'Make of Vehicle') || '',
          getColumnValue(loan, 'Year of manufacturing', 'Year of Manufacturing') || '',
          getColumnValue(loan, 'Reg No', 'Registration Number') || '',
          getColumnValue(loan, 'Name of Ins Co', 'Insurance Name') || '',
          formatDateValue(getColumnValue(loan, 'Ins valid upto', 'Insurance Validity')),
          getColumnValue(loan, 'Chassis No', 'Chasis Number') || '',
          getColumnValue(loan, 'Engine No', 'Engine Number') || '',
          getColumnValue(loan, 'Name of the surety holder', 'Surety Name') || '',
          getColumnValue(loan, 'Surety S/O W/O', 'Surety Father Name') || '',
          formatMobile(getColumnValue(loan, 'Surety Mobile')) || '',
          getColumnValue(loan, 'Surety Address') || '',
          getColumnValue(loan, 'Thumb Yes/No', 'Thumb (Yes/No)', 'Thumb') || ''
        ];

        copyText += rowData.join('\t') + '\n';
      });

      navigator.clipboard.writeText(copyText).then(() => {
        showToast(`Copied ${selectedClosedRows.size} rows! Paste in Excel.`);
      }).catch(err => {
        showToast('Failed to copy', 'error');
        console.error('Copy failed:', err);
      });
    }

    function filterClosedLoans() {
      const searchTerm = document.getElementById('closedLoanSearch').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredClosedLoans = [...closedLoansData];
      } else {
        filteredClosedLoans = closedLoansData.filter(loan => {
          // Get column value helper
          const getColumnValue = (loan, ...possibleNames) => {
            for (let name of possibleNames) {
              if (loan[name] !== undefined && loan[name] !== null && loan[name] !== '') {
                return loan[name];
              }
            }
            return '';
          };

          const customerName = (getColumnValue(loan, 'Name of the customer', 'Customer Name') || '').toString().toLowerCase();
          const mobile = (getColumnValue(loan, 'Mobile No', 'Mobile') || '').toString().toLowerCase();
          const loanNo = (getColumnValue(loan, 'Loan No', 'LoanNo', 'Loan Number') || '').toString().toLowerCase();
          
          return customerName.includes(searchTerm) || 
                 mobile.includes(searchTerm) || 
                 loanNo.includes(searchTerm);
        });
      }

      selectedClosedRows.clear();
      displayClosedLoansExcelTable();
    }

    function clearClosedLoanFilters() {
      document.getElementById('closedLoanSearch').value = '';
      filteredClosedLoans = [...closedLoansData];
      selectedClosedRows.clear();
      displayClosedLoansExcelTable();
    }

    function updateClosedLoansStats() {
      document.getElementById('totalClosedRecords').textContent = closedLoansData.length;
      document.getElementById('displayedClosedRecords').textContent = filteredClosedLoans.length;

      const totalLoanAmount = filteredClosedLoans.reduce((sum, loan) => {
        return sum + (parseFloat(loan['Loan Amount'] || 0));
      }, 0);

      document.getElementById('totalClosedLoanAmount').textContent = formatCurrency(totalLoanAmount);
    }

    function exportClosedToExcel() {
      if (filteredClosedLoans.length === 0) {
        showToast('No data to export', 'error');
        return;
      }

      const excelData = [];
      
      excelData.push([
        'S No', 'Name of the customer', 'Mobile No', 'S/o W/o', 'Name of the village', 'Address', 
        'Loan No', 'Date of loan', 'Loan Amount', 'Rate of Intt', 'No of monthly instalments',
        'Intt per one month', 'Interest', 'Principal amt', 'Total EMI', 'Total Intt',
        'Principal', 'Amt (Loan Amt + Intt)', 'Date of instalment starting', 'Total amt to be paid',
        'Difference between principal & total amt to be paid', 'Make of vehicle', 'Year of manufacturing',
        'Reg No', 'Name of Ins Co', 'Ins valid upto', 'Chassis No', 'Engine No',
        'Name of the surety holder', 'Surety S/O W/O', 'Surety Mobile', 'Surety Address', 'Thumb Yes/No'
      ]);

      filteredClosedLoans.forEach((loan, index) => {
        // Helper function to get column value
        const getColumnValue = (loan, ...possibleNames) => {
          for (let name of possibleNames) {
            if (loan[name] !== undefined && loan[name] !== null && loan[name] !== '') {
              return loan[name];
            }
          }
          return '';
        };

        excelData.push([
          getColumnValue(loan, 'S No', 'S.No', 'SNo') || (index + 1),
          getColumnValue(loan, 'Name of the customer', 'Customer Name') || '',
          formatMobile(getColumnValue(loan, 'Mobile No', 'Mobile')) || '',
          getColumnValue(loan, 'S/o W/o', 'S/O W/O', 'Father Name') || '',
          getColumnValue(loan, 'Name of the village', 'Village') || '',
          getColumnValue(loan, 'Address') || '',
          getColumnValue(loan, 'Loan No', 'LoanNo') || '',
          formatDateValue(getColumnValue(loan, 'Date of loan', 'Date of Loan')),
          getColumnValue(loan, 'Loan Amount') || '',
          getColumnValue(loan, 'Rate of Intt', 'Rate of Interest') || '',
          getColumnValue(loan, 'No of monthly instalments', 'No of monthly Ins') || '',
          getColumnValue(loan, 'Intt per one month', 'Interest per month') || '',
          getColumnValue(loan, 'Interest') || '',
          getColumnValue(loan, 'Principal amt', 'Principal Amt') || '',
          getColumnValue(loan, 'Total EMI', 'Total Emi') || '',
          getColumnValue(loan, 'Total Intt', 'Total Interest') || '',
          getColumnValue(loan, 'Principal', 'Total Principal') || '',
          getColumnValue(loan, 'Amt (Loan Amt + Intt)', 'Total Amt (Loan Amt + Intt)') || '',
          formatDateValue(getColumnValue(loan, 'Date of instalment starting', 'Date of Instalment Starting')),
          getColumnValue(loan, 'Total amt to be paid', 'Total Amount to be Paid') || '',
          getColumnValue(loan, 'Difference between principal & total amt to be paid', 'Difference') || '',
          getColumnValue(loan, 'Make of vehicle', 'Make of Vehicle') || '',
          getColumnValue(loan, 'Year of manufacturing', 'Year of Manufacturing') || '',
          getColumnValue(loan, 'Reg No', 'Registration Number') || '',
          getColumnValue(loan, 'Name of Ins Co', 'Insurance Name') || '',
          formatDateValue(getColumnValue(loan, 'Ins valid upto', 'Insurance Validity')),
          getColumnValue(loan, 'Chassis No', 'Chasis Number') || '',
          getColumnValue(loan, 'Engine No', 'Engine Number') || '',
          getColumnValue(loan, 'Name of the surety holder', 'Surety Name') || '',
          getColumnValue(loan, 'Surety S/O W/O', 'Surety Father Name') || '',
          formatMobile(getColumnValue(loan, 'Surety Mobile')) || '',
          getColumnValue(loan, 'Surety Address') || '',
          getColumnValue(loan, 'Thumb Yes/No', 'Thumb (Yes/No)', 'Thumb') || ''
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, 'Closed Loans');

      const timestamp = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `Closed_Loans_Archive_${timestamp}.xlsx`);
      
      showToast('Excel file downloaded!');
    }

    async function showClosingLoans(period) {
      try {
        showLoading(true);
        
        // Hide other containers
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('results').innerHTML = '';
        
        // Fetch all necessary data
        const ledgerRes = await fetch(`${SCRIPT_URL}?action=searchCustomers&secret=${encodeURIComponent(SECRET)}`);
        const ledgerData = await ledgerRes.json();

        if (ledgerData.status !== 'success' || !ledgerData.data) {
          throw new Error('Failed to load ledger data');
        }

        const collectionRes = await fetch(`${SCRIPT_URL}?action=searchEMIRecords&secret=${encodeURIComponent(SECRET)}`);
        const collectionData = await collectionRes.json();

        if (collectionData.status !== 'success' || !collectionData.records) {
          throw new Error('Failed to load collection data');
        }

        const scheduleRes = await fetch(`${SCRIPT_URL}?action=getAllEMISchedule&secret=${encodeURIComponent(SECRET)}`);
        const scheduleData = await scheduleRes.json();

        if (scheduleData.status !== 'success' || !scheduleData.schedule) {
          throw new Error('Failed to load schedule data');
        }

        // Calculate current date and target month
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        let targetMonth, targetYear, monthName;
        if (period === 'thisMonth') {
          targetMonth = currentMonth;
          targetYear = currentYear;
          monthName = new Date(targetYear, targetMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
        } else { // nextMonth
          targetMonth = currentMonth + 1;
          targetYear = currentYear;
          if (targetMonth > 11) {
            targetMonth = 0;
            targetYear++;
          }
          monthName = new Date(targetYear, targetMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        const closingLoans = [];

        ledgerData.data.forEach(loan => {
          const loanNo = String(loan['Loan No'] || loan['Loan Number'] || '').trim();
          if (!loanNo) return;

          const totalInstallments = parseInt(loan['No of monthly instalments'] || 
                                            loan['No of Installments'] || 
                                            loan['Installments'] || 0);
          if (!totalInstallments) return;

          // Count paid EMIs
          const collectionCount = collectionData.records.filter(r => 
            String(r['Loan No'] || r['Loan Number'] || '').trim() === loanNo
          ).length;

          const scheduleCount = scheduleData.schedule.filter(s => 
            String(s['Loan No'] || s['Loan Number'] || '').trim() === loanNo && 
            String(s['Paid'] || '').toLowerCase() === 'yes'
          ).length;

          const paidEMIs = Math.max(collectionCount, scheduleCount);
          const remainingEMIs = totalInstallments - paidEMIs;

          // Only include loans that are not yet complete and will close in target month
          if (paidEMIs < totalInstallments && remainingEMIs > 0 && remainingEMIs <= (period === 'thisMonth' ? 31 : 31)) {
            // Get the last EMI due date from schedule
            const loanSchedules = scheduleData.schedule.filter(s => 
              String(s['Loan No'] || s['Loan Number'] || '').trim() === loanNo
            ).sort((a, b) => {
              const dateA = new Date(a['EMI Due Date'] || a['Due Date'] || 0);
              const dateB = new Date(b['EMI Due Date'] || b['Due Date'] || 0);
              return dateB - dateA;
            });

            const lastEMIDate = loanSchedules.length > 0 ? (loanSchedules[0]['EMI Due Date'] || loanSchedules[0]['Due Date'] || 'N/A') : 'N/A';
            const lastEMIDateObj = new Date(lastEMIDate);
            
            // Check if last EMI falls in target month
            if (!isNaN(lastEMIDateObj.getTime())) {
              const emiMonth = lastEMIDateObj.getMonth();
              const emiYear = lastEMIDateObj.getFullYear();
              
              if (emiMonth === targetMonth && emiYear === targetYear) {
                const totalEMI = parseFloat(loan['Total EMI'] || loan['Total Emi'] || 0);
                const remainingAmount = totalEMI * remainingEMIs;

                closingLoans.push({
                  loanNo,
                  customerName: loan['Name of the customer'] || loan['Name of the Borrower'] || 'Unknown',
                  mobile: loan['Mobile No'] || loan['Mobile'] || 'N/A',
                  totalInstallments,
                  paidEMIs,
                  remainingEMIs,
                  lastEMIDate: lastEMIDateObj.toLocaleDateString('en-IN'),
                  remainingAmount
                });
              }
            }
          }
        });

        showLoading(false);

        // Display results
        if (closingLoans.length === 0) {
          showMessage(`No loans closing in ${monthName}`, 'warning');
          return;
        }

        document.getElementById('closingLoansTitle').textContent = `Loans Closing in ${monthName}`;
        document.getElementById('closingLoansSubtitle').textContent = `${closingLoans.length} loans will be completed in ${monthName}`;
        
        let tableHTML = '';
        closingLoans.forEach(loan => {
          tableHTML += `
            <tr>
              <td>${loan.loanNo}</td>
              <td>${loan.customerName}</td>
              <td>${loan.mobile}</td>
              <td>${loan.totalInstallments}</td>
              <td>${loan.paidEMIs}</td>
              <td style="color: #e74c3c; font-weight: 600;">${loan.remainingEMIs}</td>
              <td>${loan.lastEMIDate}</td>
              <td style="color: #27ae60; font-weight: 600;">₹${loan.remainingAmount.toLocaleString('en-IN')}</td>
            </tr>
          `;
        });

        document.getElementById('closingLoansBody').innerHTML = tableHTML;
        document.getElementById('closingLoansContainer').style.display = 'block';

      } catch (err) {
        showLoading(false);
        showMessage('Error: ' + err.message, 'error');
        console.error('Error:', err);
      }
    }
  </script>
</body>
</html>
