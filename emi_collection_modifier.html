<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anvitha Finance - Unified Record Modifier</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      padding-left: 100px;
      display: flex;
    }
    
    /* ===== SIDEBAR STYLES ===== */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 80px;
      height: 100vh;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      gap: 15px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    .sidebar-logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: bold;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }
    
    .sidebar-btn {
      width: 55px;
      height: 55px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      color: white;
    }
    
    .sidebar-btn:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .sidebar-btn.home {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .sidebar-btn.search {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .sidebar-btn.save {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .sidebar-btn.delete {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .sidebar-btn.info {
      background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
      margin-top: auto;
    }
    
    .sidebar-tooltip {
      position: absolute;
      left: 70px;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 12px;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1001;
    }
    
    .sidebar-btn:hover .sidebar-tooltip {
      opacity: 1;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      flex: 1;
    }
    
    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      text-align: center;
      padding: 30px;
    }
    
    .header h1 { 
      font-size: 2.5rem; 
      margin-bottom: 10px; 
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p { 
      font-size: 1.1rem; 
      opacity: 0.9; 
    }
    
    /* ===== TOAST NOTIFICATION STYLES ===== */
    .toast-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    
    .toast-backdrop.show {
      display: block;
    }
    
    .toast-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      max-width: 500px;
      width: 90%;
    }
    
    .toast {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 10px;
      padding: 20px 24px;
      display: none;
      animation: slideIn 0.3s ease-out;
      position: relative;
      border-left: 5px solid;
    }
    
    .toast.show {
      display: block;
    }
    
    .toast.success {
      border-left-color: #28a745;
      background: #d4edda;
    }
    
    .toast.error {
      border-left-color: #dc3545;
      background: #f8d7da;
    }
    
    .toast.loading {
      border-left-color: #ffc107;
      background: #fff3cd;
    }
    
    .toast-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .toast-message {
      flex-grow: 1;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .toast.success .toast-message {
      color: #155724;
      font-weight: 600;
    }
    
    .toast.error .toast-message {
      color: #721c24;
      font-weight: 600;
    }
    
    .toast.loading .toast-message {
      color: #856404;
      font-weight: 600;
    }
    
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .toast-close:hover {
      color: #333;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ffc107;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: scale(1);
        opacity: 1;
      }
      to {
        transform: scale(0.7);
        opacity: 0;
      }
    }
    
    .toast.hiding {
      animation: slideOut 0.3s ease-out forwards;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
    }
    .tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      border: none;
      border-bottom: 4px solid transparent;
      transition: all 0.3s;
      font-size: 16px;
    }
    .tab:hover { background: #e9ecef; }
    .tab.active {
      background: white;
      border-bottom-color: #3498db;
      color: #3498db;
    }
    
    .content { padding: 30px; }
    
    .search-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }
    .search-section h3 {
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    input:read-only, input.readonly {
      background: #f8f9fa;
      color: #6c757d;
    }
    textarea { resize: vertical; min-height: 80px; }
    
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: #3498db;
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      background: #2980b9;
      transform: translateY(-1px);
    }
    .btn-success {
      background: #27ae60;
      color: white;
    }
    .btn-success:hover:not(:disabled) {
      background: #229954;
      transform: translateY(-1px);
    }
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    .btn-danger:hover:not(:disabled) {
      background: #c0392b;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #3498db;
      font-weight: 600;
      display: none;
    }
    
    .results-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      margin-bottom: 25px;
      overflow: hidden;
      display: none;
    }
    .results-header {
      background: #e9ecef;
      padding: 16px 24px;
      font-weight: 600;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
    }
    .results-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .record-item {
      padding: 16px 24px;
      border-bottom: 1px solid #dee2e6;
      cursor: pointer;
      transition: background 0.2s;
    }
    .record-item:hover {
      background: #e3f2fd;
    }
    .record-item.selected {
      background: #d1ecf1;
      border-left: 4px solid #3498db;
    }
    .record-item:last-child {
      border-bottom: none;
    }
    
    .record-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .record-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2c3e50;
    }
    .record-details {
      font-size: 14px;
      color: #6c757d;
      line-height: 1.6;
    }
    
    .edit-form {
      background: white;
      border: 2px solid #3498db;
      border-radius: 12px;
      padding: 30px;
      display: none;
    }
    
    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 25px;
      line-height: 1.6;
    }
    
    .section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid #e3f2fd;
    }
    
    .form-section {
      margin-bottom: 30px;
    }
    .form-section h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid #dee2e6;
    }
    
    .hidden { display: none !important; }
    
    /* Highlighted calculated fields */
    .calculated-field {
      background: #e3f2fd !important;
      border: 2px solid #2196f3 !important;
      font-weight: bold !important;
    }
    
    .total-field {
      background: #fff3cd !important;
      border: 2px solid #ff9800 !important;
      font-weight: bold !important;
    }
    
    /* EMI Schedule Update Warning Box */
    .emi-recalc-warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
    }
    
    .emi-recalc-warning .warning-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .emi-recalc-warning .warning-icon {
      font-size: 24px;
    }
    
    .emi-recalc-warning .warning-title {
      color: #856404;
      font-weight: bold;
    }
    
    .emi-recalc-warning .warning-text {
      color: #856404;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    
    .emi-recalc-warning label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #856404;
      font-weight: 600;
    }
    
    .emi-recalc-warning input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    
    .emi-recalc-warning .warning-note {
      color: #721c24;
      font-size: 13px;
      margin-top: 8px;
      font-style: italic;
    }
    
    @media (max-width: 768px) {
      body {
        padding-left: 80px;
      }
      .sidebar {
        width: 60px;
      }
      .sidebar-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      .container { margin: 10px; }
      .content { padding: 20px; }
      .header h1 { font-size: 1.8rem; }
      .form-row { grid-template-columns: 1fr; }
      .action-buttons { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
      .toast-container {
        width: 85%;
        max-width: 90%;
      }
      .toast {
        padding: 18px 20px;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-logo">üí∞</div>
    <button class="sidebar-btn home" onclick="window.location.href='index.html'">
      <span>üè†</span>
      <div class="sidebar-tooltip">Home</div>
    </button>
    <button class="sidebar-btn search" onclick="scrollToSearch()">
      <span>üîç</span>
      <div class="sidebar-tooltip">Search</div>
    </button>
    <button class="sidebar-btn save" onclick="saveCurrentRecord()">
      <span>üíæ</span>
      <div class="sidebar-tooltip">Save Changes</div>
    </button>
    <button class="sidebar-btn delete" onclick="deleteRecord()">
      <span>üóëÔ∏è</span>
      <div class="sidebar-tooltip">Delete Record</div>
    </button>
    <button class="sidebar-btn info" onclick="showInfo()">
      <span>‚ÑπÔ∏è</span>
      <div class="sidebar-tooltip">Info</div>
    </button>
  </div>

  <!-- Toast Backdrop -->
  <div class="toast-backdrop" id="toastBackdrop"></div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üè¶ ANVITHA FINANCE</h1>
      <p>Two Wheeler Loan Management - Search & Modify Records</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="loan" onclick="switchTab('loan')">
        üìÑ Loan Records (Ledger)
      </button>
      <button class="tab" data-tab="collection" onclick="switchTab('collection')">
        üí∞ EMI Collections
      </button>
    </div>

    <div class="content">
      <!-- Search Section -->
      <div class="search-section" id="searchSection">
        <h3>üîç Search <span id="recordTypeLabel">Loan Records</span></h3>
        
        <div class="form-row">
          <div>
            <label for="searchType">Search By</label>
            <select id="searchType" onchange="updateSearchFields()">
              <option value="loanNo">Loan Number</option>
              <option value="mobile">Mobile Number</option>
              <option value="customerName">Customer Name</option>
              <option value="regNo">Registration Number</option>
            </select>
          </div>

          <div id="searchValueField">
            <label for="searchValue">Search Value <span style="color:#e74c3c">*</span></label>
            <input 
              type="text" 
              id="searchValue" 
              placeholder="Enter search value"
              onkeypress="if(event.key==='Enter') searchRecords()"
            />
          </div>

          <div id="dateRangeFields" class="hidden">
            <label for="searchFromDate">From Date</label>
            <input type="date" id="searchFromDate" />
          </div>

          <div id="dateRangeFields2" class="hidden">
            <label for="searchToDate">To Date</label>
            <input type="date" id="searchToDate" />
          </div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="searchRecords()">
            üîç Search Records
          </button>
          <button class="btn btn-secondary" onclick="clearSearch()">
            ‚úñ Clear
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading" class="loading">üîÑ Loading...</div>

      <!-- Search Results -->
      <div id="resultsContainer" class="results-container">
        <div class="results-header">
          üìã Found Records - Click to Edit
        </div>
        <div id="resultsList" class="results-list"></div>
      </div>

      <!-- Edit Form -->
      <div id="editForm" class="edit-form">
        <div class="warning-box">
          <strong>‚ö†Ô∏è Warning:</strong> You are editing an existing <span id="recordTypeWarning">loan</span> record. 
          Changes will update the <span id="sheetNameWarning">Ledger sheet</span>.
        </div>

        <h3 class="section-title">‚úèÔ∏è Edit <span id="editRecordType">Loan</span> Record</h3>

        <!-- Loan Edit Fields -->
        <div id="loanEditFields">
          <!-- Customer Information -->
          <div class="form-section">
            <h4>üë§ Customer Information</h4>
            <div class="form-row">
              <div>
                <label>Customer Name</label>
                <input type="text" id="editCustomerName" />
              </div>
              <div>
                <label>Mobile Number</label>
                <input type="text" id="editMobile" />
              </div>
              <div>
                <label>S/O W/O</label>
                <input type="text" id="editRelation" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Village</label>
                <input type="text" id="editVillage" />
              </div>
              <div style="grid-column: span 2">
                <label>Address</label>
                <textarea id="editAddress" rows="2"></textarea>
              </div>
            </div>
          </div>

          <!-- Loan Details -->
          <div class="form-section">
            <h4>üí∞ Loan Details</h4>
            <div class="form-row">
              <div>
                <label>Loan Number</label>
                <input type="text" id="editLoanNo" readonly class="readonly" />
              </div>
              <div>
                <label>Loan Date</label>
                <input type="date" id="editLoanDate" onchange="checkEMIParameterChange()" />
              </div>
              <div>
                <label>Loan Amount</label>
                <input type="number" step="0.01" id="editLoanAmount" oninput="checkEMIParameterChange()" />
              </div>
            </div>
            
            <!-- EMI Schedule Recalculation Warning -->
            <div id="emiRecalcWarning" class="emi-recalc-warning">
              <div class="warning-header">
                <span class="warning-icon">‚ö†Ô∏è</span>
                <strong class="warning-title">Loan Details Changed - EMI Schedule Update Required!</strong>
              </div>
              <p class="warning-text">
                You've changed critical loan parameters (date, amount, interest rate, or installments). 
                The EMI schedule needs to be updated to reflect these changes, including the Outstanding Balance calculation.
              </p>
              <label>
                <input type="checkbox" id="recalculateEMISchedule" />
                <span>‚úÖ Yes, recalculate and update the entire EMI schedule with correct Outstanding Balance</span>
              </label>
              <p class="warning-note">
                ‚ö†Ô∏è This will delete and regenerate all EMI entries with proper Outstanding Balance starting from total due amount for loan #<span id="warningLoanNo"></span>
              </p>
            </div>
            
            <div class="form-row">
              <div>
                <label>Interest Rate (%)</label>
                <input type="number" step="0.01" id="editInterestRate" oninput="checkEMIParameterChange()" />
              </div>
              <div>
                <label>No. of Installments</label>
                <input type="number" id="editInstallments" oninput="checkEMIParameterChange()" />
              </div>
              <div>
                <label>EMI Type</label>
                <select id="editEmiType" onchange="checkEMIParameterChange()">
                  <option value="flat">Flat (Simple Interest)</option>
                  <option value="reducing">Reducing Balance (Standard)</option>
                </select>
              </div>
            </div>
            
            <!-- Calculated Fields -->
            <div class="form-row">
              <div>
                <label>EMI per Month</label>
                <input type="number" step="0.01" id="editEmiPerMonth" readonly class="calculated-field" />
              </div>
              <div>
                <label>Interest per Month</label>
                <input type="number" step="0.01" id="editInterestPerMonth" readonly class="readonly" />
              </div>
              <div>
                <label>Principal per Month</label>
                <input type="number" step="0.01" id="editPrincipalPerMonth" readonly class="readonly" />
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>Total EMI Amount (All Months)</label>
                <input type="number" step="0.01" id="editTotalEMI" readonly class="readonly" />
              </div>
              <div>
                <label>Grand Total Interest</label>
                <input type="number" step="0.01" id="editGrandTotalInterest" readonly class="readonly" />
              </div>
              <div>
                <label>Grand Total Principal</label>
                <input type="number" step="0.01" id="editGrandTotalPrincipal" readonly class="readonly" />
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>Total Loan Due Amount (Principal + Interest)</label>
                <input type="number" step="0.01" id="editTotalLoanDue" readonly class="total-field" />
              </div>
              <div>
                <label>Date of Installment Starting</label>
                <input type="date" id="editInstallmentStartDate" readonly class="readonly" />
              </div>
              <div>
                <label>Last EMI Date</label>
                <input type="date" id="editLastEMIDate" readonly style="background:#f8f9fa;border:3px solid #ff0000;" />
              </div>
            </div>
            
            <div class="form-row">
              <div>
                <label>Total Amount to be Paid</label>
                <input type="number" step="0.01" id="editTotalAmountPaid" readonly class="readonly" />
              </div>
              <div>
                <label>Total Interest Amount</label>
                <input type="number" step="0.01" id="editDifference" readonly class="readonly" />
              </div>
            </div>
          </div>

          <!-- Vehicle Details -->
          <div class="form-section">
            <h4>üèçÔ∏è Vehicle Details</h4>
            <div class="form-row">
              <div>
                <label>Vehicle Make</label>
                <input type="text" id="editVehicleMake" />
              </div>
              <div>
                <label>Manufacturing Year</label>
                <input type="month" id="editManufacturingYear" />
              </div>
              <div>
                <label>Registration Number</label>
                <input type="text" id="editRegistrationNumber" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Insurance Company</label>
                <input type="text" id="editInsuranceCompany" />
              </div>
              <div>
                <label>Insurance Valid Upto</label>
                <input type="date" id="editInsuranceValidUpto" />
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Chassis Number</label>
                <input type="text" id="editChassisNo" />
              </div>
              <div>
                <label>Engine Number</label>
                <input type="text" id="editEngineNo" />
              </div>
            </div>
          </div>

          <!-- Surety Holder Details -->
          <div class="form-section">
            <h4>üõ°Ô∏è Surety Holder Details</h4>
            <div class="form-row">
              <div>
                <label>Surety Holder Name</label>
                <input type="text" id="editSuretyHolderName" />
              </div>
              <div>
                <label>Surety S/O W/O</label>
                <input type="text" id="editSuretyRelation" />
              </div>
              <div>
                <label>Surety Mobile Number</label>
                <input type="text" id="editSuretyMobile" />
              </div>
            </div>
            <div class="form-row">
              <div style="grid-column: span 2">
                <label>Surety Address</label>
                <textarea id="editSuretyAddress" rows="2"></textarea>
              </div>
              <div>
                <label>Thumb Yes/No/Refinance</label>
                <select id="editThumbYesNo">
                  <option value="">Select...</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Refinance">Refinance</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Collection Edit Fields -->
        <div id="collectionEditFields" class="hidden">
          <div class="form-row">
            <div>
              <label>Collection ID</label>
              <input type="text" id="editCollectionId" readonly class="readonly" />
            </div>
            <div>
              <label>Loan Number</label>
              <input type="text" id="editCollectionLoanNo" readonly class="readonly" />
            </div>
            <div>
              <label>Customer Name</label>
              <input type="text" id="editCollectionCustomerName" />
            </div>
          </div>

          <div class="form-row">
            <div>
              <label>Collection Date <span style="color:#e74c3c">*</span></label>
              <input type="date" id="editCollectionDate" required />
            </div>
            <div>
              <label>EMI Amount</label>
              <input type="number" step="0.01" id="editEmiAmount" />
            </div>
            <div>
              <label>Amount Paid <span style="color:#e74c3c">*</span></label>
              <input type="number" step="0.01" id="editAmountPaid" required />
            </div>
          </div>

          <div class="form-row">
            <div>
              <label>EMI Month/Number</label>
              <input type="text" id="editEmiMonth" />
            </div>
            <div>
              <label>Status</label>
              <select id="editStatus">
                <option value="Pending">Pending</option>
                <option value="Partial">Partial</option>
                <option value="Paid">Paid</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn btn-success" onclick="updateRecord()">
            ‚úÖ Update Record
          </button>
          <button class="btn btn-danger" onclick="deleteRecord()">
            üóëÔ∏è Delete Record
          </button>
          <button class="btn btn-secondary" onclick="cancelEdit()">
            ‚úñ Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPBMML2B8a6dMXMFL78dBIEeSRGG8yEhk2xn9BBEO_kx1kfan_Re73qOsIKAsjkQ8/exec';
    const SECRET = 'ANVITHA_SUPER_SECRET_2025';

    let activeTab = 'loan';
    let searchResults = [];
    let selectedRecord = null;
    let selectedRecordIndex = -1;
    let originalLoanDate = '';
    let originalLoanAmount = '';
    let originalInterestRate = '';
    let originalInstallments = '';

    // ===== HELPER FUNCTIONS =====
    function formatDateToDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      try {
        if (typeof dateStr === 'string' && dateStr.includes('-')) {
          const parts = dateStr.split('T')[0].split('-');
          if (parts.length === 3) {
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];
            return `${day}-${month}-${year}`;
          }
        }
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      } catch (e) {
        return dateStr;
      }
    }
    
    function formatLoanDateForDisplay(raw) {
      if (!raw) return 'N/A';
      try {
        if (raw instanceof Date) {
          const d = raw;
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const yyyy = d.getFullYear();
          return `${dd}-${mm}-${yyyy}`;
        }
        if (typeof raw === 'string' && (raw.includes('T') || raw.includes('Z'))) {
          const d = new Date(raw);
          if (isNaN(d.getTime())) return raw;
          const dd = String(d.getDate()).padStart(2, '0');
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const yyyy = d.getFullYear();
          return `${dd}-${mm}-${yyyy}`;
        }
        if (typeof raw === 'string' && raw.indexOf('-') !== -1) {
          const parts = raw.split('-');
          if (parts.length === 3 && parts[0].length === 2 && parts[2].length === 4) {
            return raw;
          }
          if (parts.length === 3 && parts[0].length === 4) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
          }
        }
        return String(raw);
      } catch (e) {
        console.error('formatLoanDateForDisplay error:', e, raw);
        return String(raw);
      }
    }

    function scrollToSearch() {
      document.getElementById('searchSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function saveCurrentRecord() {
      if (selectedRecord) {
        updateRecord();
      } else {
        showToast('No record selected to save', 'error', 3000);
      }
    }

    function showInfo() {
      showToast(
        'Anvitha Finance - Record Modifier<br>' +
        'üìã Version 2.1 - Outstanding Balance Fix<br>' +
        '‚ú® Features: Search, Edit, Delete<br>' +
        'üíæ Auto-save to Google Sheets<br>' +
        'üìä Proper Outstanding Balance Calculation<br>' +
        'üì± Mobile Responsive Design',
        'success',
        8000
      );
    }

    // ===== TOAST NOTIFICATION SYSTEM =====
    function showToast(message, type = 'success', duration = 5000) {
      const container = document.getElementById('toastContainer');
      const backdrop = document.getElementById('toastBackdrop');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      let icon = '‚úî';
      if (type === 'error') icon = '‚úï';
      if (type === 'loading') icon = '<div class="spinner"></div>';
      
      toast.innerHTML = `
        <div class="toast-content">
          <div class="toast-icon">${icon}</div>
          <div class="toast-message">${message}</div>
          ${type !== 'loading' ? '<button class="toast-close" onclick="closeToast(this)">√ó</button>' : ''}
        </div>
      `;
      
      container.appendChild(toast);
      backdrop.classList.add('show');
      setTimeout(() => toast.classList.add('show'), 10);
      
      if (type !== 'loading' && duration > 0) {
        setTimeout(() => hideToast(toast), duration);
      }
      
      return toast;
    }

    function hideToast(toast) {
      const backdrop = document.getElementById('toastBackdrop');
      const container = document.getElementById('toastContainer');
      
      toast.classList.add('hiding');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
        if (container.children.length === 0) {
          backdrop.classList.remove('show');
        }
      }, 300);
    }

    function closeToast(button) {
      const toast = button.closest('.toast');
      hideToast(toast);
    }

    function hideLoadingToasts() {
      const loadingToasts = document.querySelectorAll('.toast.loading');
      loadingToasts.forEach(toast => hideToast(toast));
    }

    function showMessage(text, type = 'success') {
      showToast(text, type, 5000);
    }

    let currentLoadingToast = null;
    
    function showLoading(show = true) {
      document.getElementById('loading').style.display = 'none';
      
      if (show) {
        if (!currentLoadingToast) {
          currentLoadingToast = showToast('üîÑ Processing...', 'loading', 0);
        }
      } else {
        if (currentLoadingToast) {
          hideToast(currentLoadingToast);
          currentLoadingToast = null;
        }
        hideLoadingToasts();
      }
    }

    // ===== CALCULATION FUNCTIONS FOR EDIT FORM =====
    function calculateEMI() {
      const loanAmount = parseFloat(document.getElementById('editLoanAmount').value) || 0;
      const interestRate = parseFloat(document.getElementById('editInterestRate').value) || 0;
      const installments = parseFloat(document.getElementById('editInstallments').value) || 0;
      const emiType = document.getElementById('editEmiType').value || 'flat';
      const loanDate = document.getElementById('editLoanDate').value;

      if (loanAmount <= 0 || installments <= 0) {
        document.getElementById('editEmiPerMonth').value = '';
        document.getElementById('editInterestPerMonth').value = '';
        document.getElementById('editPrincipalPerMonth').value = '';
        document.getElementById('editTotalEMI').value = '';
        document.getElementById('editGrandTotalInterest').value = '';
        document.getElementById('editGrandTotalPrincipal').value = '';
        document.getElementById('editTotalLoanDue').value = '';
        document.getElementById('editTotalAmountPaid').value = '';
        document.getElementById('editDifference').value = '';
        document.getElementById('editInstallmentStartDate').value = '';
        document.getElementById('editLastEMIDate').value = '';
        return;
      }

      let monthlyEMI, totalInterest, monthlyInterest, monthlyPrincipal;

      if (emiType === 'flat') {
        const timeInYears = installments / 12;
        totalInterest = (loanAmount * interestRate * timeInYears) / 100;
        const totalAmount = loanAmount + totalInterest;
        monthlyEMI = totalAmount / installments;
        monthlyInterest = totalInterest / installments;
        monthlyPrincipal = monthlyEMI - monthlyInterest;
      } else {
        const monthlyRate = (interestRate / 100) / 12;
        if (monthlyRate === 0) {
          monthlyEMI = loanAmount / installments;
          totalInterest = 0;
          monthlyInterest = 0;
        } else {
          monthlyEMI = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, installments)) / 
                       (Math.pow(1 + monthlyRate, installments) - 1);
          const totalAmount = monthlyEMI * installments;
          totalInterest = totalAmount - loanAmount;
          monthlyInterest = totalInterest / installments;
        }
        monthlyPrincipal = monthlyEMI - monthlyInterest;
      }

      monthlyEMI = Math.round(monthlyEMI / 10) * 10;
      const totalEMI = monthlyEMI * installments;
      const adjustedTotalInterest = totalEMI - loanAmount;

      document.getElementById('editEmiPerMonth').value = monthlyEMI.toFixed(2);
      document.getElementById('editInterestPerMonth').value = monthlyInterest.toFixed(2);
      document.getElementById('editPrincipalPerMonth').value = (monthlyEMI - monthlyInterest).toFixed(2);
      document.getElementById('editTotalEMI').value = totalEMI.toFixed(2);
      document.getElementById('editGrandTotalInterest').value = adjustedTotalInterest.toFixed(2);
      document.getElementById('editGrandTotalPrincipal').value = loanAmount.toFixed(2);
      document.getElementById('editTotalLoanDue').value = totalEMI.toFixed(2);
      document.getElementById('editTotalAmountPaid').value = totalEMI.toFixed(2);
      document.getElementById('editDifference').value = adjustedTotalInterest.toFixed(2);

      if (loanDate) {
        const date = new Date(loanDate);
        date.setMonth(date.getMonth() + 1);
        document.getElementById('editInstallmentStartDate').value = date.toISOString().split('T')[0];

        const lastDate = new Date(loanDate);
        lastDate.setMonth(lastDate.getMonth() + installments);
        document.getElementById('editLastEMIDate').value = lastDate.toISOString().split('T')[0];
      } else {
        document.getElementById('editInstallmentStartDate').value = '';
        document.getElementById('editLastEMIDate').value = '';
      }
    }

    function checkEMIParameterChange() {
      const currentLoanDate = document.getElementById('editLoanDate').value;
      const currentLoanAmount = document.getElementById('editLoanAmount').value;
      const currentInterestRate = document.getElementById('editInterestRate').value;
      const currentInstallments = document.getElementById('editInstallments').value;
      
      calculateEMI();
      
      const warningBox = document.getElementById('emiRecalcWarning');
      const loanNo = document.getElementById('editLoanNo').value;
      
      const dateChanged = currentLoanDate && originalLoanDate && currentLoanDate !== originalLoanDate;
      const amountChanged = currentLoanAmount && originalLoanAmount && currentLoanAmount !== originalLoanAmount;
      const rateChanged = currentInterestRate && originalInterestRate && currentInterestRate !== originalInterestRate;
      const installmentsChanged = currentInstallments && originalInstallments && currentInstallments !== originalInstallments;
      
      if (dateChanged || amountChanged || rateChanged || installmentsChanged) {
        warningBox.style.display = 'block';
        document.getElementById('warningLoanNo').textContent = loanNo;
      } else {
        warningBox.style.display = 'none';
        document.getElementById('recalculateEMISchedule').checked = false;
      }
    }

    function switchTab(tab) {
      activeTab = tab;
      
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tab);
      });

      document.getElementById('recordTypeLabel').textContent = 
        tab === 'loan' ? 'Loan Records' : 'Collection Records';
      
      const searchType = document.getElementById('searchType');
      searchType.innerHTML = '';
      
      if (tab === 'loan') {
        searchType.innerHTML = `
          <option value="loanNo">Loan Number</option>
          <option value="mobile">Mobile Number</option>
          <option value="customerName">Customer Name</option>
          <option value="regNo">Registration Number</option>
        `;
      } else {
        searchType.innerHTML = `
          <option value="loanNo">Loan Number</option>
          <option value="collectionId">Collection ID</option>
          <option value="customerName">Customer Name</option>
          <option value="dateRange">Date Range</option>
        `;
      }

      updateSearchFields();
      clearSearch();
    }

    function updateSearchFields() {
      const searchType = document.getElementById('searchType').value;
      const searchValueField = document.getElementById('searchValueField');
      const dateRangeFields = document.getElementById('dateRangeFields');
      const dateRangeFields2 = document.getElementById('dateRangeFields2');

      if (searchType === 'dateRange') {
        searchValueField.classList.add('hidden');
        dateRangeFields.classList.remove('hidden');
        dateRangeFields2.classList.remove('hidden');
      } else {
        searchValueField.classList.remove('hidden');
        dateRangeFields.classList.add('hidden');
        dateRangeFields2.classList.add('hidden');
        
        const input = document.getElementById('searchValue');
        const placeholders = {
          loanNo: 'Enter loan number',
          mobile: 'Enter mobile number',
          customerName: 'Enter customer name',
          regNo: 'Enter registration number',
          collectionId: 'Enter collection ID'
        };
        input.placeholder = placeholders[searchType] || 'Enter search value';
      }
    }

    async function searchRecords() {
      const searchType = document.getElementById('searchType').value;
      const searchValue = document.getElementById('searchValue').value.trim();
      const fromDate = document.getElementById('searchFromDate').value;
      const toDate = document.getElementById('searchToDate').value;

      if (searchType !== 'dateRange' && !searchValue) {
        showMessage('Please enter a search value', 'error');
        return;
      }

      if (searchType === 'dateRange' && (!fromDate || !toDate)) {
        showMessage('Please select both from and to dates', 'error');
        return;
      }

      showLoading(true);
      
      try {
        let url;
        
        if (activeTab === 'loan') {
          url = `${SCRIPT_URL}?action=searchrecord&searchType=${encodeURIComponent(searchType)}&searchValue=${encodeURIComponent(searchValue)}&secret=${encodeURIComponent(SECRET)}`;
          
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.status === 'success' && data.data) {
            searchResults = [data.data];
            displayResults();
            showMessage('Loan record found', 'success');
          } else if (data.status === 'not_found') {
            searchResults = [];
            document.getElementById('resultsContainer').style.display = 'none';
            showMessage(`No loan record found for ${searchType}: "${searchValue}"`, 'error');
          } else {
            searchResults = [];
            document.getElementById('resultsContainer').style.display = 'none';
            showMessage(data.message || 'No loan record found', 'error');
          }
        } else {
          url = `${SCRIPT_URL}?action=searchEMIRecords&secret=${encodeURIComponent(SECRET)}`;
          
          if (searchType === 'loanNo') {
            url += `&loanNo=${encodeURIComponent(searchValue)}`;
          } else if (searchType === 'dateRange') {
            url += `&from=${encodeURIComponent(fromDate)}&to=${encodeURIComponent(toDate)}`;
          }
          
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.status === 'success' && Array.isArray(data.records)) {
            let filteredRecords = data.records;
            
            if (searchType === 'collectionId') {
              filteredRecords = data.records.filter(r => 
                String(r['Collection ID'] || '').toLowerCase().includes(searchValue.toLowerCase())
              );
            } else if (searchType === 'customerName') {
              filteredRecords = data.records.filter(r => 
                String(r['Customer Name'] || '').toLowerCase().includes(searchValue.toLowerCase())
              );
            }
            
            searchResults = filteredRecords;
            displayResults();
            showMessage(`Found ${filteredRecords.length} collection record(s)`, 'success');
          } else {
            searchResults = [];
            document.getElementById('resultsContainer').style.display = 'none';
            showMessage('No collection records found', 'error');
          }
        }
      } catch (error) {
        console.error('Search error:', error);
        showMessage('Error searching records: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function displayResults() {
      const container = document.getElementById('resultsContainer');
      const list = document.getElementById('resultsList');
      
      if (searchResults.length === 0) {
        container.style.display = 'none';
        return;
      }

      let html = '';
      searchResults.forEach((record, index) => {
        if (activeTab === 'loan') {
          const customerName = record['Name of the customer'] || 'N/A';
          const loanNo = record['Loan No'] || 'N/A';
          const mobile = record['Mobile No'] || 'N/A';
          const loanAmount = record['Loan Amount'] || 'N/A';
          const vehicleMake = record['Make of vehicle'] || 'N/A';
          const regNo = record['Registration Number'] || 'N/A';
          const loanDate = formatLoanDateForDisplay(record['Date of loan']);
          
          html += `
            <div class="record-item" onclick="selectRecord(${index})">
              <div class="record-summary">
                <div class="record-title">${customerName}</div>
                <button class="btn btn-primary" style="padding:6px 16px;font-size:13px">Edit</button>
              </div>
              <div class="record-details">
                <strong>Loan No:</strong> ${loanNo} | <strong>Mobile:</strong> ${mobile}<br>
                <strong>Loan Amount:</strong> ‚Çπ${loanAmount} | <strong>Vehicle:</strong> ${vehicleMake}<br>
                <strong>Reg No:</strong> ${regNo} | <strong>Loan Date:</strong> ${loanDate}
              </div>
            </div>
          `;
        } else {
          const status = (record['Status'] || '').toLowerCase();
          const statusColor = status === 'paid' ? '#27ae60' : 
                             status === 'partial' ? '#f39c12' : '#e74c3c';
          const collectionDate = formatLoanDateForDisplay(record['Collection Date']);
          
          html += `
            <div class="record-item" onclick="selectRecord(${index})">
              <div class="record-summary">
                <div class="record-title">${record['Collection ID'] || 'N/A'}</div>
                <button class="btn btn-primary" style="padding:6px 16px;font-size:13px">Edit</button>
              </div>
              <div class="record-details">
                <strong>${record['Customer Name'] || 'N/A'}</strong> (Loan: ${record['Loan Number'] || 'N/A'})<br>
                EMI ${record['EMI Month'] || 'N/A'} | Date: ${collectionDate} | Amount: ‚Çπ${record['Amount Paid'] || record['Amoiunt Paid'] || 'N/A'}<br>
                Status: <span style="color:${statusColor};font-weight:600">${record['Status'] || 'N/A'}</span>
              </div>
            </div>
          `;
        }
      });

      list.innerHTML = html;
      container.style.display = 'block';
    }

    function selectRecord(index) {
      selectedRecordIndex = index;
      selectedRecord = searchResults[index];
      
      document.querySelectorAll('.record-item').forEach((item, i) => {
        item.classList.toggle('selected', i === index);
      });

      document.getElementById('recordTypeWarning').textContent = activeTab === 'loan' ? 'loan' : 'collection';
      document.getElementById('sheetNameWarning').textContent = 
        activeTab === 'loan' ? 'Ledger sheet' : 'emi_collection sheet and corresponding emi_schedule entry';
      document.getElementById('editRecordType').textContent = activeTab === 'loan' ? 'Loan' : 'Collection';

      document.getElementById('loanEditFields').classList.toggle('hidden', activeTab !== 'loan');
      document.getElementById('collectionEditFields').classList.toggle('hidden', activeTab !== 'collection');

      if (activeTab === 'loan') {
        document.getElementById('editCustomerName').value = selectedRecord['Name of the customer'] || '';
        document.getElementById('editMobile').value = selectedRecord['Mobile No'] || '';
        document.getElementById('editRelation').value = selectedRecord['S/o W/o'] || '';
        document.getElementById('editVillage').value = selectedRecord['Name of the village'] || '';
        document.getElementById('editAddress').value = selectedRecord['Address'] || '';
        document.getElementById('editLoanNo').value = selectedRecord['Loan No'] || '';
        
        let loanDateValue = selectedRecord['Date of loan'] || '';
        if (loanDateValue) {
          try {
            if (loanDateValue instanceof Date) {
              const year = loanDateValue.getFullYear();
              const month = String(loanDateValue.getMonth() + 1).padStart(2, '0');
              const day = String(loanDateValue.getDate()).padStart(2, '0');
              loanDateValue = `${year}-${month}-${day}`;
            } else if (typeof loanDateValue === 'string') {
              if (loanDateValue.includes('T') || loanDateValue.includes('Z')) {
                const dateObj = new Date(loanDateValue);
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                loanDateValue = `${year}-${month}-${day}`;
              } else if (loanDateValue.match(/^\d{2}-\d{2}-\d{4}$/)) {
                const parts = loanDateValue.split('-');
                loanDateValue = `${parts[2]}-${parts[1]}-${parts[0]}`;
              }
            }
          } catch (e) {
            console.error('Error parsing loan date:', e);
            loanDateValue = '';
          }
        }
        document.getElementById('editLoanDate').value = loanDateValue;
        originalLoanDate = loanDateValue;
        
        originalLoanAmount = parseFloat(selectedRecord['Loan Amount']) || 0;
        originalInterestRate = parseFloat(selectedRecord['Rate of intt']) || 0;
        originalInstallments = parseInt(selectedRecord['No of monthly instalments']) || 0;
        
        document.getElementById('emiRecalcWarning').style.display = 'none';
        document.getElementById('recalculateEMISchedule').checked = false;
        
        document.getElementById('editLoanAmount').value = selectedRecord['Loan Amount'] || '';
        document.getElementById('editInterestRate').value = selectedRecord['Rate of intt'] || '';
        document.getElementById('editInstallments').value = selectedRecord['No of monthly instalments'] || '';
        document.getElementById('editEmiType').value = selectedRecord['EMI Type'] || 'flat';
        
        document.getElementById('editEmiPerMonth').value = selectedRecord['EMI per month'] || '';
        document.getElementById('editInterestPerMonth').value = selectedRecord['Interest per month'] || '';
        document.getElementById('editPrincipalPerMonth').value = selectedRecord['Principal per month'] || '';
        document.getElementById('editTotalEMI').value = selectedRecord['Total EMI'] || '';
        document.getElementById('editGrandTotalInterest').value = selectedRecord['Grand Total Interest'] || '';
        document.getElementById('editGrandTotalPrincipal').value = selectedRecord['Grand Total Principal'] || '';
        document.getElementById('editTotalLoanDue').value = selectedRecord['Total Loan Due'] || '';
        
        let instStartDate = selectedRecord['Date of instalment starting'] || '';
        if (instStartDate && typeof instStartDate === 'string' && instStartDate.includes('T')) {
          const d = new Date(instStartDate);
          instStartDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        document.getElementById('editInstallmentStartDate').value = instStartDate;
        
        let lastEMIDate = selectedRecord['Last Emi date'] || '';
        if (lastEMIDate && typeof lastEMIDate === 'string' && lastEMIDate.includes('T')) {
          const d = new Date(lastEMIDate);
          lastEMIDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        document.getElementById('editLastEMIDate').value = lastEMIDate;
        
        document.getElementById('editTotalAmountPaid').value = selectedRecord['Total amount to be paid'] || '';
        document.getElementById('editDifference').value = selectedRecord['Difference'] || '';
        
        document.getElementById('editVehicleMake').value = selectedRecord['Make of vehicle'] || '';
        
        let yearValue = selectedRecord['Year of manufacturing'] || '';
        if (yearValue) {
          try {
            if (yearValue instanceof Date) {
              const year = yearValue.getFullYear();
              const month = String(yearValue.getMonth() + 1).padStart(2, '0');
              yearValue = `${year}-${month}`;
            } else if (typeof yearValue === 'string') {
              if (yearValue.includes('T') || yearValue.includes('Z')) {
                const dateObj = new Date(yearValue);
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                yearValue = `${year}-${month}`;
              }
            }
          } catch (e) {
            console.error('Error parsing manufacturing year:', e);
            yearValue = '';
          }
        }
        document.getElementById('editManufacturingYear').value = yearValue;
        
        document.getElementById('editRegistrationNumber').value = selectedRecord['Reg No'] || '';
        document.getElementById('editInsuranceCompany').value = selectedRecord['Name of Ins Co'] || '';
        
        let insDate = selectedRecord['Ins valid upto'] || '';
        if (insDate && typeof insDate === 'string' && insDate.includes('T')) {
          const d = new Date(insDate);
          insDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        document.getElementById('editInsuranceValidUpto').value = insDate;
        
        document.getElementById('editChassisNo').value = selectedRecord['Chassis No'] || '';
        document.getElementById('editEngineNo').value = selectedRecord['Engine No'] || '';
        
        document.getElementById('editSuretyHolderName').value = selectedRecord['Name of the surety holder'] || '';
        document.getElementById('editSuretyRelation').value = selectedRecord['Surety S/O W/O'] || '';
        
        let suretyMobile = selectedRecord['Surety Mobile'] || '';
        if (typeof suretyMobile === 'number') {
          suretyMobile = String(suretyMobile);
        }
        document.getElementById('editSuretyMobile').value = suretyMobile;
        
        document.getElementById('editSuretyAddress').value = selectedRecord['Surety Address'] || '';
        document.getElementById('editThumbYesNo').value = selectedRecord['Thumb Yes/No'] || '';
        
      } else {
        document.getElementById('editCollectionId').value = selectedRecord['Collection ID'] || '';
        document.getElementById('editCollectionLoanNo').value = selectedRecord['Loan Number'] || '';
        document.getElementById('editCollectionCustomerName').value = selectedRecord['Customer Name'] || '';
        
        let collectionDateValue = selectedRecord['Collection Date'] || '';
        if (collectionDateValue && typeof collectionDateValue === 'string') {
          if (collectionDateValue.includes('T') || collectionDateValue.includes('Z')) {
            collectionDateValue = collectionDateValue.split('T')[0];
          } else if (collectionDateValue.match(/^\d{2}-\d{2}-\d{4}$/)) {
            const parts = collectionDateValue.split('-');
            collectionDateValue = `${parts[2]}-${parts[1]}-${parts[0]}`;
          }
        }
        document.getElementById('editCollectionDate').value = collectionDateValue;
        
        document.getElementById('editEmiAmount').value = selectedRecord['EMI Amount'] || '';
        document.getElementById('editAmountPaid').value = selectedRecord['Amount Paid'] || selectedRecord['Amoiunt Paid'] || '';
        document.getElementById('editEmiMonth').value = selectedRecord['EMI Month'] || '';
        document.getElementById('editStatus').value = selectedRecord['Status'] || 'Pending';
      }

      document.getElementById('editForm').style.display = 'block';
      document.getElementById('editForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function updateRecord() {
      if (!selectedRecord) {
        showMessage('No record selected', 'error');
        return;
      }

      showLoading(true);
      try {
        let payload;
        
        if (activeTab === 'loan') {
          const updatedData = [
            selectedRecord[0],
            document.getElementById('editCustomerName').value,
            document.getElementById('editMobile').value,
            document.getElementById('editRelation').value,
            document.getElementById('editVillage').value,
            document.getElementById('editAddress').value,
            document.getElementById('editLoanNo').value,
            document.getElementById('editLoanDate').value,
            document.getElementById('editLoanAmount').value,
            document.getElementById('editInterestRate').value,
            document.getElementById('editInstallments').value,
            document.getElementById('editInterestPerMonth').value,
            document.getElementById('editInterestPerMonth').value,
            document.getElementById('editPrincipalPerMonth').value,
            document.getElementById('editEmiPerMonth').value,
            document.getElementById('editGrandTotalInterest').value,
            document.getElementById('editGrandTotalPrincipal').value,
            document.getElementById('editTotalLoanDue').value,
            document.getElementById('editInstallmentStartDate').value,
            document.getElementById('editLastEMIDate').value,
            document.getElementById('editTotalAmountPaid').value,
            document.getElementById('editDifference').value,
            document.getElementById('editVehicleMake').value,
            document.getElementById('editManufacturingYear').value,
            document.getElementById('editRegistrationNumber').value,
            document.getElementById('editInsuranceCompany').value,
            document.getElementById('editInsuranceValidUpto').value,
            document.getElementById('editChassisNo').value,
            document.getElementById('editEngineNo').value,
            document.getElementById('editSuretyHolderName').value,
            document.getElementById('editSuretyRelation').value,
            document.getElementById('editSuretyMobile').value,
            document.getElementById('editSuretyAddress').value,
            document.getElementById('editThumbYesNo').value
          ];

          const recalculateEMI = document.getElementById('recalculateEMISchedule').checked;
          
          payload = {
            action: 'update',
            secret: SECRET,
            loanNo: document.getElementById('editLoanNo').value,
            updates: updatedData,
            recalculateEMISchedule: recalculateEMI
          };
          
          if (recalculateEMI) {
            const confirmRecalc = confirm(
              `‚ö†Ô∏è IMPORTANT CONFIRMATION\n\n` +
              `You are about to:\n` +
              `1. Update the loan record\n` +
              `2. DELETE all existing EMI schedule entries for loan #${document.getElementById('editLoanNo').value}\n` +
              `3. REGENERATE the entire EMI schedule with proper Outstanding Balance calculation\n\n` +
              `The Outstanding Balance will start from the total due amount (Principal + Interest) and decrease with each EMI.\n\n` +
              `This will affect all EMI due dates and cannot be undone.\n\n` +
              `Are you sure you want to proceed?`
            );
            
            if (!confirmRecalc) {
              showLoading(false);
              return;
            }
            
            // ‚úÖ CRITICAL FIX: Send correct field names matching Google Apps Script expectations
            payload.emiCalculationData = {
              loanNo: document.getElementById('editLoanNo').value,
              customerName: document.getElementById('editCustomerName').value,
              loanDate: document.getElementById('editLoanDate').value,
              installmentStartDate: document.getElementById('editInstallmentStartDate').value,
              numberOfInstallments: parseInt(document.getElementById('editInstallments').value),
              emiPerMonth: parseFloat(document.getElementById('editEmiPerMonth').value),  // ‚úÖ Changed from emiAmount to emiPerMonth
              principalPerMonth: parseFloat(document.getElementById('editPrincipalPerMonth').value),
              interestPerMonth: parseFloat(document.getElementById('editInterestPerMonth').value),
              totalLoanDue: parseFloat(document.getElementById('editTotalLoanDue').value)
            };
            
            // Log for debugging
            console.log('EMI Calculation Data being sent:', payload.emiCalculationData);
          }
        } else {
          payload = {
            action: 'updateCollection',
            secret: SECRET,
            collectionId: selectedRecord['Collection ID'],
            updates: {
              'Collection ID': document.getElementById('editCollectionId').value,
              'Loan Number': document.getElementById('editCollectionLoanNo').value,
              'Customer Name': document.getElementById('editCollectionCustomerName').value,
              'Collection Date': document.getElementById('editCollectionDate').value,
              'EMI Amount': document.getElementById('editEmiAmount').value,
              'Amount Paid': document.getElementById('editAmountPaid').value,
              'EMI Month': document.getElementById('editEmiMonth').value,
              'Status': document.getElementById('editStatus').value
            }
          };
        }

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (result.status === 'success') {
          let successMsg = `${activeTab === 'loan' ? 'Loan' : 'Collection'} record updated successfully!`;
          
          if (activeTab === 'loan' && document.getElementById('recalculateEMISchedule').checked) {
            successMsg += '\n‚úÖ EMI schedule has been recalculated with proper Outstanding Balance starting from total due amount!';
          }
          
          showMessage(successMsg, 'success');
          searchRecords();
          cancelEdit();
        } else {
          showMessage(result.message || 'Update failed', 'error');
        }
      } catch (error) {
        showMessage('Error updating record: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function deleteRecord() {
      if (!selectedRecord) {
        showMessage('No record selected', 'error');
        return;
      }

      let confirmMsg;
      if (activeTab === 'loan') {
        confirmMsg = `Are you sure you want to delete this loan record?\n\nLoan Number: ${document.getElementById('editLoanNo').value}\nCustomer: ${document.getElementById('editCustomerName').value}\n\nThis action cannot be undone.`;
      } else {
        confirmMsg = `Are you sure you want to delete this collection record?\n\nCollection ID: ${document.getElementById('editCollectionId').value}\nCustomer: ${document.getElementById('editCollectionCustomerName').value}\nAmount: ‚Çπ${document.getElementById('editAmountPaid').value}\n\nThis action cannot be undone and will update the emi_schedule.`;
      }
      
      if (!confirm(confirmMsg)) return;

      showLoading(true);
      try {
        let payload;
        
        if (activeTab === 'loan') {
          payload = {
            action: 'deleteLoan',
            secret: SECRET,
            loanNo: document.getElementById('editLoanNo').value
          };
        } else {
          payload = {
            action: 'deleteCollection',
            secret: SECRET,
            collectionId: selectedRecord['Collection ID'],
            loanNumber: selectedRecord['Loan Number'],
            emiMonth: selectedRecord['EMI Month']
          };
        }

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (result.status === 'success') {
          showMessage(`${activeTab === 'loan' ? 'Loan' : 'Collection'} record deleted successfully!`, 'success');
          searchRecords();
          cancelEdit();
        } else {
          showMessage(result.message || 'Delete failed', 'error');
        }
      } catch (error) {
        showMessage('Error deleting record: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function cancelEdit() {
      document.getElementById('editForm').style.display = 'none';
      selectedRecord = null;
      selectedRecordIndex = -1;
      
      document.querySelectorAll('.record-item').forEach(item => {
        item.classList.remove('selected');
      });
    }

    function clearSearch() {
      document.getElementById('searchValue').value = '';
      document.getElementById('searchFromDate').value = '';
      document.getElementById('searchToDate').value = '';
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('editForm').style.display = 'none';
      searchResults = [];
      selectedRecord = null;
      selectedRecordIndex = -1;
    }

    updateSearchFields();
  </script>
</body>
</html>
